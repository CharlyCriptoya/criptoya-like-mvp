<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tienda Fortnite · MVP</title>
  <style>
    :root{
      --bg:#0f1116; --card:#151925; --muted:#8a94a7; --text:#e7edf5;
      --brand:#5dd0ff; --ok:#2ecc71; --warn:#ffd166; --err:#ff6b6b;
      --border:#22283a; --shadow:0 8px 28px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
      background: radial-gradient(1200px 600px at 10% -10%, #1d2340 0%, transparent 60%), var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter: blur(6px);
      background:linear-gradient(180deg, rgba(15,17,22,.9), rgba(15,17,22,.5) 60%, transparent);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:18px}
    .row-3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:18px}
    @media (max-width:900px){ .row,.row-3{grid-template-columns:1fr} }
    .brand{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.3px}
    .brand .logo{width:34px; height:34px; border-radius:10px; background:linear-gradient(135deg, #5dd0ff, #6b9cff); box-shadow:var(--shadow)}
    .btn{
      display:inline-flex; align-items:center; gap:10px; border:1px solid var(--border);
      background:#1a2030; color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer;
      text-decoration:none; font-weight:600;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(135deg, #5dd0ff, #6b9cff); color:#0b1220; border:none}
    .btn.ok{background:linear-gradient(135deg, #7ee2a6, #2ecc71); color:#0b1220; border:none}
    .btn.warn{background:linear-gradient(135deg, #ffe08a, #ffd166); color:#2b2100; border:none}
    .btn.ghost{background:transparent}
    .card{
      background:linear-gradient(180deg, #161b29, #121726);
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px;
    }
    h1{font-size:1.4rem; margin:6px 0 0}
    h2{font-size:1.05rem; margin:0 0 12px; color:#cfe6ff}
    p{color:var(--muted); margin:6px 0 12px}
    label{display:block; font-size:.92rem; margin:8px 0 6px; color:#cfe6ff}
    input,select,textarea{
      width:100%; background:#0f1320; color:var(--text); border:1px solid var(--border);
      border-radius:10px; padding:10px 12px; outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#5dd0ff; box-shadow:0 0 0 3px rgba(93,208,255,.15)}
    .muted{color:var(--muted)}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; font-size:.82rem; border:1px solid var(--border); background:#0f1422}
    .status{display:inline-flex; align-items:center; gap:8px}
    .status .dot{width:10px; height:10px; border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.err{background:var(--err)}
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border); padding:10px 8px; text-align:left; font-size:.95rem}
    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0c101a; border:1px solid var(--border); border-radius:8px; padding:6px 10px}
    footer{opacity:.8; padding:24px 0 40px}
    small{color:#9fb0c6}
    .right{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div style="opacity:.85">Tienda Fortnite</div>
          <h1>MVP – pedidos, 48 h y códigos</h1>
        </div>
      </div>
      <div class="right">
        <a id="discordLink" class="btn" href="#" target="_blank" rel="noopener">Entrar al Discord</a>
        <button class="btn ghost" id="clearBtn" title="Borrar datos locales">Reiniciar demo</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="margin-top:12px">
    <div class="row">
      <section class="card">
        <h2>1) Tu Epic ID & reloj de 48 h</h2>
        <p>Para <b>gift in-game</b> necesitás ser amigo 48 h. Guardá tu <b>Epic display name</b> y usá “Marcar amistad aceptada” cuando ya se confirmó.</p>
        <label for="epic">Epic ID</label>
        <input id="epic" placeholder="p.ej. Carlos-AR-2008" />
        <div style="display:flex; gap:10px; margin-top:10px">
          <button class="btn primary" id="saveEpic">Guardar ID</button>
          <button class="btn" id="markFriend">Marcar amistad aceptada (inicia 48 h)</button>
        </div>
        <div style="margin-top:14px">
          <div class="status">
            <span id="friendDot" class="dot warn"></span>
            <div>
              <div id="friendStatus" class="muted">Esperando confirmación de amistad…</div>
              <small id="countdown" class="muted"></small>
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>2) Crear pedido</h2>
        <div class="row">
          <div>
            <label for="tipo">Tipo</label>
            <select id="tipo">
              <option value="gift">Gift in-game (48 h)</option>
              <option value="code">Código oficial (V-Bucks / tienda)</option>
            </select>
          </div>
          <div>
            <label for="referencia">Referencia</label>
            <input id="referencia" placeholder="Link del ítem o SKU del código" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label for="precio">Precio (centavos)</label>
            <input id="precio" type="number" placeholder="p.ej. 50000 (=$500)" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="crearPedido" class="btn ok" style="width:100%">Crear pedido</button>
          </div>
        </div>
        <p class="muted" style="margin-top:8px">Tip: si elegís <b>código</b>, al acreditarse el pago se entrega automático (si hay stock del SKU).</p>
      </section>
    </div>

    <div class="row" style="margin-top:18px">
      <section class="card">
        <h2>3) Pago</h2>
        <p>Este checkout es <b>simulado</b> (para probar UX). En producción iría Mercado Pago / Stripe / PayPal con su <i>webhook</i>.</p>
        <div class="row">
          <div>
            <label for="pedidoId">ID de pedido</label>
            <input id="pedidoId" type="number" placeholder="Último ID aparece en la tabla" />
          </div>
          <div style="display:flex; align-items:flex-end; gap:10px">
            <button id="checkoutBtn" class="btn primary">Generar link de pago</button>
            <button id="markPaid" class="btn">Marcar como pagado (webhook)</button>
          </div>
        </div>
        <p style="margin-top:12px">Checkout: <span id="checkoutUrl" class="code">—</span></p>
      </section>

      <section class="card">
        <h2>4) Stock de <span class="pill">códigos</span> (admin demo)</h2>
        <div class="row">
          <div>
            <label for="sku">SKU</label>
            <input id="sku" placeholder="p.ej. VB-1000-PSN" />
          </div>
          <div>
            <label for="codeInput">Código</label>
            <input id="codeInput" placeholder="XXXX-XXXX-XXXX" />
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button id="addCode" class="btn">Agregar al stock</button>
          <button id="listCodes" class="btn ghost">Ver stock</button>
        </div>
        <p id="stockMsg" class="muted" style="margin-top:10px">—</p>
      </section>
    </div>

    <section class="card" style="margin-top:18px">
      <h2>Pedidos</h2>
      <div style="overflow:auto">
        <table id="tabla">
          <thead>
            <tr>
              <th>ID</th><th>Tipo</th><th>Referencia</th><th>Estado</th><th>Monto</th><th>Creado</th><th>Pago</th><th>Entrega</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted" style="margin-top:8px">Estados: <span class="pill">awaiting_payment</span> → <span class="pill">paid</span> → <span class="pill">delivered</span>.</p>
    </section>

    <footer class="wrap">
      <small>
        Demo educativa. No inicia sesión en plataformas ni evade reglas. El gifting requiere amistad 48 h; los códigos deben ser de retailers/partners oficiales.
        Configurá tus términos y política de reembolsos antes de abrir ventas reales.
      </small>
    </footer>
  </main>

  <script>
    // --- Helpers de almacenamiento ---
    const LS = (k, v) => v === undefined ? JSON.parse(localStorage.getItem(k) || "null") : localStorage.setItem(k, JSON.stringify(v));
    const money = cents => (cents/100).toLocaleString('es-AR', {style:'currency', currency:'ARS'});

    // --- Estado base ---
    const state = {
      epic: LS('epic') || "",
      friendSince: LS('friendSince') || null, // ISO date
      orders: LS('orders') || [],
      nextId: LS('nextId') || 1,
      codes: LS('codes') || [] // {sku, code, used:false}
    };

    // --- DOM refs ---
    const epicEl = document.getElementById('epic');
    const saveEpicBtn = document.getElementById('saveEpic');
    const markFriendBtn = document.getElementById('markFriend');
    const friendStatus = document.getElementById('friendStatus');
    const friendDot = document.getElementById('friendDot');
    const countdownEl = document.getElementById('countdown');

    const tipoEl = document.getElementById('tipo');
    const refEl = document.getElementById('referencia');
    const precioEl = document.getElementById('precio');
    const crearPedidoBtn = document.getElementById('crearPedido');

    const pedidoIdEl = document.getElementById('pedidoId');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const markPaidBtn = document.getElementById('markPaid');
    const checkoutUrlEl = document.getElementById('checkoutUrl');

    const skuEl = document.getElementById('sku');
    const codeInputEl = document.getElementById('codeInput');
    const addCodeBtn = document.getElementById('addCode');
    const listCodesBtn = document.getElementById('listCodes');
    const stockMsg = document.getElementById('stockMsg');

    const tablaBody = document.querySelector('#tabla tbody');
    const clearBtn = document.getElementById('clearBtn');

    // --- Persistencia ---
    function persist(){
      LS('epic', state.epic);
      LS('friendSince', state.friendSince);
      LS('orders', state.orders);
      LS('nextId', state.nextId);
      LS('codes', state.codes);
      render();
    }

    // --- Render principal ---
    function render(){
      epicEl.value = state.epic || "";

      // Reloj 48h
      if(!state.friendSince){
        friendStatus.textContent = "Esperando confirmación de amistad…";
        friendDot.className = "dot warn";
        countdownEl.textContent = "";
      }else{
        const since = new Date(state.friendSince);
        const target = new Date(since.getTime() + 48*60*60*1000);
        const now = new Date();
        const remain = target - now;
        if(remain <= 0){
          friendStatus.textContent = "¡Listo para regalar! Ya pasaron las 48 h.";
          friendDot.className = "dot ok";
          countdownEl.textContent = "";
        }else{
          friendStatus.textContent = "Contando 48 h desde que se aceptó la amistad…";
          friendDot.className = "dot warn";
          const hrs = Math.floor(remain/3600000);
          const mins = Math.floor((remain%3600000)/60000);
          const secs = Math.floor((remain%60000)/1000);
          countdownEl.textContent = `Faltan ${hrs} h ${mins} m ${secs} s`;
        }
      }

      // Tabla de pedidos
      tablaBody.innerHTML = "";
      state.orders.slice().sort((a,b)=>b.id-a.id).forEach(o=>{
        const tr = document.createElement('tr');
        const fmt = x => x ? new Date(x).toLocaleString() : "—";
        tr.innerHTML = `
          <td>${o.id}</td>
          <td>${o.type}</td>
          <td>${o.reference}</td>
          <td><span class="pill">${o.status}</span></td>
          <td>${money(o.amount_cents || 0)}</td>
          <td>${fmt(o.created_utc)}</td>
          <td>${fmt(o.paid_utc)}</td>
          <td>${o.type==='code' && o.delivered_code ? `<span class="code">${o.delivered_code}</span>` : fmt(o.delivered_utc)}</td>
          <td></td>
        `;
        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '6px';

        // Acciones según estado
        if(o.status === 'awaiting_payment'){
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.textContent = 'Checkout';
          btn.onclick = ()=>generateCheckout(o.id);
          actions.appendChild(btn);
        }
        if(o.status === 'paid'){
          const btn = document.createElement('button');
          btn.className = 'btn ok';
          btn.textContent = o.type==='code' ? 'Entregar código' : 'Marcar gift entregado';
          btn.onclick = ()=>deliverOrder(o.id);
          actions.appendChild(btn);
        }
        const tdActions = document.createElement('td');
        tdActions.appendChild(actions);
        tr.appendChild(tdActions);
        tablaBody.appendChild(tr);
      });
    }

    // --- Lógica de negocio (demo) ---
    function saveEpic(){
      state.epic = epicEl.value.trim();
      persist();
      alert('Epic ID guardado.');
    }

    function markFriend(){
      state.friendSince = new Date().toISOString();
      persist();
      alert('¡Listo! Empezaron a correr las 48 h.');
    }

    function createOrder(){
      const t = tipoEl.value;
      const r = refEl.value.trim();
      const p = parseInt(precioEl.value, 10) || 0;
      if(!r){ alert('Poné la referencia (link o SKU).'); return; }
      if(!p || p<0){ alert('Precio inválido.'); return; }
      const order = {
        id: state.nextId++,
        type: t,
        reference: r,
        status: 'awaiting_payment',
        amount_cents: p,
        created_utc: new Date().toISOString(),
        paid_utc: null,
        delivered_utc: null,
        delivered_code: null
      };
      state.orders.push(order);
      persist();
      alert(`Pedido #${order.id} creado.`);
      pedidoIdEl.value = order.id;
    }

    function generateCheckout(id){
      const o = state.orders.find(x=>x.id==id);
      if(!o){ alert('Pedido no encontrado'); return; }
      const url = `https://checkout.simulado/ORD-${o.id}-${Math.random().toString(36).slice(2,8)}`;
      checkoutUrlEl.textContent = url;
      checkoutUrlEl.title = url;
      pedidoIdEl.value = o.id;
    }

    function markPaid(){
      const id = parseInt(pedidoIdEl.value, 10);
      const o = state.orders.find(x=>x.id===id);
      if(!o){ alert('Elegí un ID válido.'); return; }
      if(o.status!=='awaiting_payment'){ alert('Ese pedido no está esperando pago.'); return; }
      o.status='paid';
      o.paid_utc=new Date().toISOString();
      persist();
      alert(`Pedido #${o.id} marcado como pagado.`);
    }

    function deliverOrder(id){
      const o = state.orders.find(x=>x.id==id);
      if(!o){ alert('Pedido no encontrado'); return; }
      if(o.status!=='paid'){ alert('El pedido todavía no está pagado.'); return; }

      if(o.type==='code'){
        // Buscar stock por SKU (o.reference)
        const idx = state.codes.findIndex(c=>!c.used && c.sku===o.reference);
        if(idx===-1){
          alert('Sin stock de ese SKU. Cargá un código en "Stock de códigos".');
          return;
        }
        const code = state.codes[idx];
        code.used = true;
        o.delivered_code = code.code;
        o.delivered_utc = new Date().toISOString();
        o.status='delivered';
        persist();
        alert(`Código entregado: ${code.code}`);
      }else{ // gift
        // Chequear 48h
        if(!state.friendSince){
          alert('Todavía no marcaste la amistad aceptada.');
          return;
        }
        const since = new Date(state.friendSince);
        if(new Date() - since < 48*60*60*1000){
          alert('Aún no se cumplieron las 48 h.');
          return;
        }
        o.delivered_utc = new Date().toISOString();
        o.status='delivered';
        persist();
        alert('Pedido marcado como entregado (gift).');
      }
    }

    function addCode(){
      const sku = skuEl.value.trim();
      const code = codeInputEl.value.trim();
      if(!sku || !code){ alert('Completá SKU y Código.'); return; }
      state.codes.push({sku, code, used:false});
      skuEl.value=""; codeInputEl.value="";
      persist();
      stockMsg.textContent = 'Código agregado al stock.';
    }

    function listCodes(){
      const libres = state.codes.filter(c=>!c.used).length;
      const usados = state.codes.length - libres;
      const detalle = state.codes.map(c=>`${c.sku} · ${c.used?'USADO':'LIBRE'} · ${c.code}`).join('\n') || '(sin códigos)';
      stockMsg.textContent = `En stock: ${libres} libres, ${usados} usados.\n${detalle}`;
    }

    function clearAll(){
      if(confirm('Esto borra toda la demo (localStorage). ¿Continuar?')){
        localStorage.clear();
        location.reload();
      }
    }

    // --- Eventos ---
    saveEpicBtn.addEventListener('click', saveEpic);
    markFriendBtn.addEventListener('click', markFriend);
    crearPedidoBtn.addEventListener('click', createOrder);
    checkoutBtn.addEventListener('click', ()=>{
      const id = parseInt(pedidoIdEl.value, 10);
      if(!id){ alert('Ingresá un ID de pedido.'); return; }
      generateCheckout(id);
    });
    markPaidBtn.addEventListener('click', markPaid);
    addCodeBtn.addEventListener('click', addCode);
    listCodesBtn.addEventListener('click', listCodes);
    clearBtn.addEventListener('click', clearAll);

    // --- Tick de countdown ---
    setInterval(()=>render(), 1000);

    // Init
    render();
  </script>
</body>
</html>
