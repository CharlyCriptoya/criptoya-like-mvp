<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0b0f16" />
  <title>Arbolito â€” Cotizaciones</title>
  <style>
    :root{--text:#e5e7eb;--muted:#a1a1aa;--line:rgba(255,255,255,.08);--cardBg:rgba(10,13,20,.84);
          --chipBg:rgba(255,255,255,.06);--ok:#22c55e;--bad:#ef4444;--accent:#60a5fa}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
         background:#0b0f16 url('Muro.jpg') center/cover fixed no-repeat;overflow-x:hidden}
    .page{max-width:480px;margin:0 auto;padding:12px}
    h1{margin:6px 0 10px;font-size:18px;letter-spacing:.2px}
    .card{background:var(--cardBg);border:1px solid var(--line);border-radius:14px;padding:10px}
    .grid-dolar{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .dl-title{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:4px;font-variant-numeric:tabular-nums}
    .row span:first-child{color:var(--muted);font-size:12px}
    .updated{margin-top:4px;font-size:11px;color:var(--muted)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tab{padding:11px 14px;border-radius:999px;background:#fff;color:#0b0f16;border:1px solid #e5e7eb;font-size:14px;font-weight:700}
    .tab.active{background:#f3f4f6;border-color:#cbd5e1}
    .chip{font-size:11px;padding:2px 8px;border-radius:999px;background:var(--chipBg);border:1px solid var(--line);color:var(--muted)}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{padding:10px 10px;text-align:left} th{font-size:11px;color:var(--muted);border-bottom:1px solid var(--line)}
    tbody tr{background:var(--cardBg);border:1px solid var(--line)}
    tbody td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .price{font-variant-numeric:tabular-nums}.green{color:var(--ok)}.red{color:var(--bad)}
    .meta{margin:8px 2px 2px;color:var(--muted);font-size:11px}
    .skeleton{background:linear-gradient(90deg,rgba(255,255,255,.04) 25%,rgba(255,255,255,.08) 37%,rgba(255,255,255,.04) 63%);
             background-size:400% 100%;animation:sh 1.2s ease infinite;border-radius:10px}
    @keyframes sh{0%{background-position:100% 50%}100%{background-position:0 50%}}
    a{color:var(--accent);text-decoration:none}
    .ai-wrap{margin-top:12px}
    .ai-grid{display:grid;gap:10px}
    @media(min-width:520px){.ai-grid{grid-template-columns:1fr}}
    .ai-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .ai-toolbar input,.ai-toolbar select{background:rgba(255,255,255,.08);border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px}
    .btn{padding:9px 12px;border:1px solid var(--line);background:var(--chipBg);color:var(--text);border-radius:10px;cursor:pointer}
    .btn.primary{background:#fff;color:#111;font-weight:700}
    #chart{height:320px}
    .note{font-size:11px;color:var(--muted);margin-top:6px}
    .stats24h{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0;font-size:12px}
    .stat-box{flex:1;min-width:120px;background:var(--cardBg);border:1px solid var(--line);border-radius:10px;padding:8px}
    .ranges{display:flex;gap:6px;margin-top:6px}
    .range-btn{flex:1;padding:6px 8px;border:1px solid var(--line);border-radius:6px;background:var(--chipBg);cursor:pointer;font-size:12px}
    .range-btn.active{background:#fff;color:#111;font-weight:700}
    .ai-out{white-space:pre-wrap;background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
<div class="page">
  <!-- Cotizaciones dÃ³lar -->
  <section>
    <h1>ðŸ’± Cotizaciones del DÃ³lar (ARS)</h1>
    <div id="dolares" class="grid-dolar"></div>
  </section>

  <!-- Pares -->
  <section style="margin-top:12px">
    <div style="display:flex;align-items:center;gap:8px">
      <h1 style="margin:0">ðŸª™ Pares</h1>
      <span id="apiStatus" class="chip">API: comprobandoâ€¦</span>
    </div>
    <div id="tabs" class="tabs"></div>
    <div class="card">
      <table>
        <thead><tr><th>Exchange</th><th>Par</th><th>Compra</th><th>Venta</th><th>24h</th><th>Act.</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="meta">DÃ³lar por <a href="https://dolarapi.com" target="_blank">dolarapi</a>. Cripto por <a href="https://criptoya.com" target="_blank">CriptoYa</a> y APIs oficiales (con fallback).</div>
  </section>

  <!-- GrÃ¡fico + IA -->
  <section class="ai-wrap">
    <h1 style="margin:0 0 6px">ðŸ“ˆ GrÃ¡fico & ðŸ¤– AnÃ¡lisis</h1>
    <div class="card">
      <div class="ai-grid">
        <div>
          <div class="ai-toolbar">
            <select id="wgExchange">
              <option value="binance">Binance</option>
              <option value="okx">OKX</option>
              <option value="bybit">Bybit</option>
              <option value="kucoin">KuCoin</option>
              <option value="mexc">MEXC</option>
              <option value="bingx">BingX</option>
            </select>
            <input id="wgBase" placeholder="BTC, ETH, SOLâ€¦" size="8"/>
            <select id="wgQuote"><option value="USDT">USDT</option></select>
            <select id="wgTF"><option>1m</option><option>5m</option><option>15m</option><option>1h</option><option>4h</option><option>1d</option></select>
            <button class="btn primary" id="btnLoad">Cargar grÃ¡fico</button>
            <button class="btn" id="btnDownload">Descargar PNG</button>
          </div>
          <div id="stats24h" class="stats24h"></div>
          <div class="ranges">
            <button class="range-btn active" data-tf="1m">1m</button>
            <button class="range-btn" data-tf="5m">5m</button>
            <button class="range-btn" data-tf="15m">15m</button>
            <button class="range-btn" data-tf="1h">1h</button>
            <button class="range-btn" data-tf="4h">4h</button>
            <button class="range-btn" data-tf="1d">1d</button>
          </div>
          <div id="chart"></div>
        </div>
        <div>
          <div class="ai-toolbar">
            <input id="openaiKey" placeholder="Tu OpenAI API Key (sk-â€¦)" style="flex:1;min-width:220px"/>
            <button class="btn" id="btnSaveKey">Guardar clave</button>
          </div>
          <button class="btn primary" id="btnAI">Analizar con IA</button>
          <span class="badge" id="autoSigToggle">Auto-seÃ±ales: OFF</span>
          <div class="ai-out" id="aiOut">CargÃ¡ un grÃ¡fico y opcionalmente pegÃ¡ tu clave de OpenAI para obtener un anÃ¡lisis. Las auto-seÃ±ales usan EMA20/EMA50 y RSI14 locales (no IA).</div>
        </div>
      </div>
    </div>
  </section>
</div>

<script src="https://unpkg.com/lightweight-charts@4.2.3/dist/lightweight-charts.standalone.production.js"></script>
<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const nfUS=new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});

let chart, candleSeries, lastCandles=[];

function initChart(){
  chart?.remove();
  chart = LightweightCharts.createChart($('#chart'),{
    width: $('#chart').clientWidth, height: 320,
    layout:{background:{type:'solid',color:'transparent'},textColor:'#e5e7eb'},
    crosshair:{mode:LightweightCharts.CrosshairMode.Normal},
    grid:{vertLines:{color:'rgba(255,255,255,0.06)'},horzLines:{color:'rgba(255,255,255,0.06)'}},
    rightPriceScale:{borderVisible:false}, timeScale:{borderVisible:false}
  });
  candleSeries = chart.addCandlestickSeries();
  chart.subscribeCrosshairMove(param=>{
    if(param?.point && param.time){
      const c=param.seriesData.get(candleSeries);
      if(c){
        $('#aiOut').textContent=`${new Date(param.time*1000).toLocaleString()} | O:${c.open} H:${c.high} L:${c.low} C:${c.close}`;
      }
    }
  });
  new ResizeObserver(()=> chart.applyOptions({width: $('#chart').clientWidth})).observe($('#chart'));
}

async function fetchKlines(base,quote,tf){
  const r=await fetch(`https://api.binance.com/api/v3/klines?symbol=${base}${quote}&interval=${tf}&limit=300`);
  const j=await r.json();
  return j.map(k=>({t:+k[0],o:+k[1],h:+k[2],l:+k[3],c:+k[4]}));
}

function updateStats24h(data){
  if(!data?.length) return;
  const closes=data.map(d=>+d.c), highs=data.map(d=>+d.h), lows=data.map(d=>+d.l);
  const last=closes.at(-1), max=Math.max(...highs), min=Math.min(...lows);
  const chg=((last-closes[0])/closes[0])*100;
  $('#stats24h').innerHTML=`
    <div class="stat-box"><strong>Ãšltimo</strong><br>${nfUS.format(last)}</div>
    <div class="stat-box"><strong>MÃ¡x 24h</strong><br>${nfUS.format(max)}</div>
    <div class="stat-box"><strong>MÃ­n 24h</strong><br>${nfUS.format(min)}</div>
    <div class="stat-box"><strong>Cambio</strong><br>${chg.toFixed(2)}%</div>`;
}

async function loadChartFromUI(){
  const base=($('#wgBase').value||'BTC').toUpperCase();
  const quote=$('#wgQuote').value||'USDT';
  const tf=$('#wgTF').value||'1m';
  $('#aiOut').textContent='Cargando velasâ€¦';
  const data=await fetchKlines(base,quote,tf);
  lastCandles=data; initChart();
  candleSeries.setData(data.map(d=>({time:Math.floor(d.t/1000),open:+d.o,high:+d.h,low:+d.l,close:+d.c})));
  updateStats24h(data);
  $('#aiOut').textContent=`Listo: ${base}/${quote} ${tf} (${data.length} velas)`;
}

$('#btnLoad').onclick=loadChartFromUI;
$('#btnDownload').onclick=()=>{const cv=$('#chart canvas'); if(cv){const a=document.createElement('a'); a.download=`chart.png`; a.href=cv.toDataURL(); a.click();}};
$$('.range-btn').forEach(btn=>btn.onclick=()=>{$$('.range-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); $('#wgTF').value=btn.dataset.tf; loadChartFromUI();});

initChart(); loadChartFromUI();
</script>
</body>
</html>
