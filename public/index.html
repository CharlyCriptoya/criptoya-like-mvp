<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charly Cripto ‚Ä¢ MVP</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{--bg:#0e0f13;--card:#151821;--mut:#9aa3b2;--line:#232833;--txt:#e8ecf1}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0 0 10px;font-size:22px}
  .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
  .mut{color:var(--mut)}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#0f1218;border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-width:160px}
  .chip b{display:block}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px;text-align:left}
  th{font-weight:700}
  .right{text-align:right}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 10px}
  select,button{background:#0f1218;color:var(--txt);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:14px}
  button{cursor:pointer}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .stat{background:#0f1218;border:1px solid var(--line);border-radius:10px;padding:10px}
  .stat b{display:block;font-size:12px;color:var(--mut);margin-bottom:6px}
  .pair-grid{display:grid;gap:12px}
  @media(min-width:900px){.pair-grid{grid-template-columns:1fr 1fr}}
  .pair-card{background:#0f1218;border:1px solid var(--line);border-radius:12px;padding:12px}
  .pair-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
</style>
</head>
<body>
  <main class="wrap">
    <h1>üíµ Cotizaciones del D√≥lar (ARS)</h1>
    <div class="mut">D√≥lar por <a href="https://dolarapi.com" target="_blank" style="color:#9ecbff">dolarapi</a> ‚Ä¢ Cripto por Binance y <a href="https://criptoya.com" target="_blank" style="color:#9ecbff">CriptoYa</a> (v√≠a backend).</div>

    <!-- D√ìLAR -->
    <section class="section">
      <div id="cards-dolar" class="chips">Cargando d√≥lar‚Ä¶</div>
    </section>

    <!-- PARES (por exchange) -->
    <section class="section">
      <h2 style="margin:0 0 8px">Pares por exchange (ARS)</h2>
      <div class="mut" id="pares-status">API: comprobando‚Ä¶</div>

      <div class="pair-grid" id="pairs">
        <!-- Se rellenan estas cuatro tarjetas: USDT/ARS, DAI/ARS, BTC/ARS, ETH/ARS -->
      </div>
    </section>

    <!-- GR√ÅFICO + AN√ÅLISIS -->
    <section class="section">
      <h2 style="margin:0 0 8px">üìà Gr√°fico (Binance) & Stats 24 h</h2>
      <div class="controls">
        <select id="symbol">
          <option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option>
          <option>BNBUSDT</option><option>ADAUSDT</option>
        </select>
        <select id="interval">
          <option>1m</option><option>5m</option><option>15m</option>
          <option selected>1h</option><option>4h</option><option>1d</option>
        </select>
        <button id="btn-load">Cargar gr√°fico</button>
        <button id="btn-png">Descargar PNG</button>
      </div>

      <div class="stats">
        <div class="stat"><b>√öltimo</b><span id="st-last">‚Äî</span></div>
        <div class="stat"><b>M√°x 24h</b><span id="st-high">‚Äî</span></div>
        <div class="stat"><b>M√≠n 24h</b><span id="st-low">‚Äî</span></div>
        <div class="stat"><b>Cambio 24h</b><span id="st-pct">‚Äî</span></div>
      </div>

      <div style="margin-top:12px">
        <canvas id="chart" height="360"></canvas>
      </div>

      <div class="section" style="margin-top:12px">
        <h3 style="margin:0 0 8px;font-size:16px">ü§ñ An√°lisis t√©cnico r√°pido</h3>
        <div class="mut" id="ai">Sin datos.</div>
      </div>
    </section>
  </main>

<script>
const $ = s => document.querySelector(s);
const fmt = n => Number(n).toLocaleString('es-AR', {maximumFractionDigits:2});

// ======= D√ìLAR =======
async function cargarDolar(){
  try{
    const d = await (await fetch('/api/dolar')).json();
    const tipos = ["oficial","blue","tarjeta","mep","ccl","cripto"];
    const sel = d.filter(x => {
      const nombre = (x.casa || x.nombre || '').toLowerCase();
      return tipos.includes(nombre);
    });
    $('#cards-dolar').innerHTML = sel.map(row=>{
      const nombre = (row.casa || row.nombre || 'D√ìLAR').toUpperCase();
      const venta = fmt(row.venta || row.venta_promedio || 0);
      const compra = fmt(row.compra || row.compra_promedio || 0);
      return `<div class="chip"><b>${nombre}</b>
                <div class="mut">venta <b style="color:#fff">$ ${venta}</b></div>
                <div class="mut">compra <b style="color:#fff">$ ${compra}</b></div>
              </div>`;
    }).join('') || '<div class="mut">Sin datos</div>';
  }catch(e){
    $('#cards-dolar').innerHTML = '<div class="mut">No se pudo cargar el d√≥lar.</div>';
  }
}

// ======= PARES por exchange (CriptoYa) =======
const PARES = [
  { asset:'usdt', fiat:'ars', title:'USDT/ARS' },
  { asset:'dai',  fiat:'ars', title:'DAI/ARS'  },
  { asset:'btc',  fiat:'ars', title:'BTC/ARS'  },
  { asset:'eth',  fiat:'ars', title:'ETH/ARS'  },
];

function renderPairCard(title, rows){
  const tbody = rows.map(r => `
    <tr>
      <td style="color:#9ecbff;font-weight:700">${r.ex.toUpperCase()}</td>
      <td>${title}</td>
      <td class="right">$ ${fmt(r.bid||0)}</td>
      <td class="right">$ ${fmt(r.ask||0)}</td>
    </tr>
  `).join('');
  return `
    <div class="pair-card">
      <div class="pair-title"><b>${title}</b><span class="mut">${rows.length} exchanges</span></div>
      <table>
        <thead><tr><th>Exchange</th><th>Par</th><th class="right">Compra</th><th class="right">Venta</th></tr></thead>
        <tbody>${tbody || `<tr><td colspan="4" class="mut">Sin datos</td></tr>`}</tbody>
      </table>
    </div>`;
}

async function cargarPares(){
  const status = $('#pares-status');
  const container = $('#pairs');
  status.textContent = 'API: comprobando‚Ä¶';
  container.innerHTML = '';

  for (const p of PARES){
    try{
      const data = await (await fetch(`/api/criptoya/${p.asset}/${p.fiat}/1`)).json();
      const exs = Object.keys(data).filter(k=>data[k]).sort();
      const rows = exs.map(ex => ({
        ex,
        bid: data[ex]?.totalBid,
        ask: data[ex]?.totalAsk
      }));
      container.insertAdjacentHTML('beforeend', renderPairCard(p.title, rows));
    }catch(e){
      container.insertAdjacentHTML('beforeend', renderPairCard(p.title, []));
    }
  }
  status.textContent = 'API: ok';
}

// ======= GR√ÅFICO & AN√ÅLISIS =======
let chart;
function sma(arr, len){
  const out=[]; let sum=0;
  for(let i=0;i<arr.length;i++){ sum+=arr[i]; if(i>=len) sum-=arr[i-len]; if(i>=len-1) out.push(sum/len); }
  return out;
}
function rsi(closes, p=14){
  if(closes.length<=p) return [];
  let gain=0, loss=0;
  for(let i=1;i<=p;i++){ const ch=closes[i]-closes[i-1]; gain+=Math.max(ch,0); loss+=Math.max(-ch,0); }
  let avgG=gain/p, avgL=loss/p; const out=new Array(p).fill(null);
  for(let i=p+1;i<closes.length;i++){
    const ch=closes[i]-closes[i-1];
    avgG=(avgG*(p-1)+Math.max(ch,0))/p;
    avgL=(avgL*(p-1)+Math.max(-ch,0))/p;
    const rs = avgL===0 ? 100 : avgG/avgL;
    out.push(100-(100/(1+rs)));
  }
  return out;
}
function analisis(kl){
  if(!kl?.length) return "Sin datos.";
  const closes = kl.map(k=>k.c);
  const last   = closes.at(-1);
  const ma20   = sma(closes,20).at(-1);
  const _rsi   = rsi(closes).at(-1);
  let msg = `√öltimo: ${fmt(last)}. `;
  if(ma20!=null){ msg += last>ma20? "Sobre MA20. " : "Bajo MA20. "; }
  if(_rsi!=null){ msg += `RSI‚âà${_rsi.toFixed(0)} (${_rsi>70?"sobrecompra":_rsi<30?"sobreventa":"neutral"}).`; }
  return msg;
}
function renderChart(labels, closes, label){
  if(chart) chart.destroy();
  chart = new Chart(document.getElementById('chart'), {
    type:'line',
    data:{labels, datasets:[{label, data:closes, pointRadius:0, borderWidth:1.6, tension:.2}]},
    options:{interaction:{mode:'index',intersect:false},scales:{x:{grid:{color:'#232833'}},y:{grid:{color:'#232833'}}}}
  });
}

async function cargarTickerYGrafico(){
  const sym = $('#symbol').value, interval = $('#interval').value;

  // Stats 24h
  try{
    const t = await (await fetch(`/api/binance/ticker?symbol=${sym}`)).json();
    const pct = Number(t.priceChangePercent ?? t.pct ?? 0);
    $('#st-last').textContent = fmt(t.last||0);
    $('#st-high').textContent = fmt(t.high24h||0);
    $('#st-low').textContent  = fmt(t.low24h||0);
    $('#st-pct').textContent  = (pct>=0?'+':'') + pct.toFixed(2) + '%';
  }catch{}

  // Klines
  try{
    const kl = await (await fetch(`/api/binance/klines?symbol=${sym}&interval=${interval}&limit=300`)).json();
    const labels = kl.map(k=>new Date(k.t));
    const closes = kl.map(k=>k.c);
    renderChart(labels, closes, sym);
    $('#ai').textContent = analisis(kl);
  }catch{
    $('#ai').textContent = 'No se pudo cargar el gr√°fico.';
  }
}

$('#btn-load').addEventListener('click', cargarTickerYGrafico);
$('#btn-png').addEventListener('click', ()=>{
  const url = document.getElementById('chart').toDataURL('image/png');
  const a=document.createElement('a'); a.href=url; a.download='grafico.png'; a.click();
});

// Arranque
cargarDolar();
cargarPares();
cargarTickerYGrafico();
</script>
</body>
</html>
