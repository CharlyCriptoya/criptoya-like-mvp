<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charly Cripto ‚Ä¢ MVP</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{--bg:#0e0f13;--card:#151821;--mut:#9aa3b2;--line:#232833;--txt:#e8ecf1}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0 0 10px;font-size:22px}
  .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
  .mut{color:var(--mut)}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#0f1218;border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-width:160px}
  .chip b{display:block}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px;text-align:left}
  th{font-weight:700}
  .right{text-align:right}
  .pair-grid{display:grid;gap:12px}
  @media(min-width:900px){.pair-grid{grid-template-columns:1fr 1fr}}
  .pair-card{background:#0f1218;border:1px solid var(--line);border-radius:12px;padding:12px}
  .pair-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 10px}
  select,button,textarea,input{background:#0f1218;color:var(--txt);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:14px}
  button{cursor:pointer}
</style>
</head>
<body>
  <main class="wrap">
    <h1>üíµ Cotizaciones del D√≥lar (ARS)</h1>
    <div class="mut">D√≥lar por <a href="https://dolarapi.com" target="_blank" style="color:#9ecbff">dolarapi</a> ‚Ä¢ Cripto por Binance y <a href="https://criptoya.com" target="_blank" style="color:#9ecbff">CriptoYa</a> (v√≠a backend).</div>

    <!-- D√ìLAR -->
    <section class="section">
      <div id="cards-dolar" class="chips">Cargando d√≥lar‚Ä¶</div>
    </section>

    <!-- PARES (mix: ARS + USDT) -->
    <section class="section">
      <h2 style="margin:0 0 8px">Pares por exchange</h2>
      <div class="mut" id="pares-status">API: comprobando‚Ä¶</div>

      <div class="pair-grid" id="pairs">
        <!-- Se rellenan estas tarjetas:
             - USDT/ARS (como antes)
             - BTC/USDT, ETH/USDT, SOL/USDT (nuevas en USDT) -->
      </div>
    </section>

    <!-- GR√ÅFICO + IA + CHAT -->
    <section class="section" id="ai-block">
      <h2 style="margin:0 0 8px">üìâ Gr√°fico + IA</h2>
      <div class="controls">
        <select id="sym">
          <option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option>
          <option>BNBUSDT</option><option>ADAUSDT</option><option>XRPUSDT</option>
          <option>DOGEUSDT</option><option>MATICUSDT</option><option>LINKUSDT</option>
          <option>TONUSDT</option>
        </select>
        <select id="tf">
          <option value="15m">15m</option><option value="1h" selected>1h</option>
          <option value="4h">4h</option><option value="1d">1d</option>
        </select>
        <button id="btnLoad">Cargar gr√°fico</button>
        <button id="btnScan">Escanear tendencias</button>
      </div>

      <div id="chartWrap" style="height:360px;background:#0f1115;border-radius:12px"></div>

      <div class="section" style="margin-top:12px">
        <h3 style="margin:0 0 8px;font-size:16px">ü§ñ Se√±al r√°pida</h3>
        <div id="signalText" class="mut">‚Äî</div>
      </div>

      <div class="section" style="margin-top:12px">
        <h3 style="margin:0 0 8px;font-size:16px">üß™ An√°lisis t√©cnico</h3>
        <div id="atText" class="mut">‚Äî</div>
      </div>

      <div class="section" style="margin-top:12px">
        <h3 style="margin:0 0 8px;font-size:16px">üí¨ Chat de An√°lisis (sin API key)</h3>
        <div class="mut" style="margin-bottom:8px">Genera un informe usando los indicadores locales (EMA, RSI, MACD, ATR, soportes/resistencias). No usa servicios externos.</div>
        <div class="controls">
          <input id="risk" type="number" step="0.5" min="0" max="100" placeholder="% riesgo por trade (ej. 1)" style="width:220px">
          <select id="sidePref">
            <option value="auto" selected>Auto (seg√∫n se√±al)</option>
            <option value="long">Solo LONG</option>
            <option value="short">Solo SHORT</option>
          </select>
          <button id="btnInforme">Generar informe</button>
        </div>
        <textarea id="aiOut" rows="8" style="width:100%;resize:vertical" placeholder="Ac√° ver√°s el informe t√©cnico‚Ä¶"></textarea>
      </div>

      <div class="section" style="margin-top:12px">
        <h3 style="margin:0 0 8px;font-size:16px">üîé Scanner de tendencias (USDT)</h3>
        <div id="scanInfo" class="mut">Presion√° ‚ÄúEscanear tendencias‚Äù.</div>
        <div style="overflow:auto;margin-top:8px">
          <table style="width:100%;min-width:520px">
            <thead>
              <tr style="border-bottom:1px solid var(--line)">
                <th>Par</th><th>TF</th><th>Tendencia</th><th>Se√±al</th><th>RSI14</th><th>Comentario</th>
              </tr>
            </thead>
            <tbody id="scanBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

<!-- Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<script>
const $ = s => document.querySelector(s);
const fmt = (n,d=2)=> Number(n).toLocaleString('es-AR',{maximumFractionDigits:d});

// ======= D√ìLAR =======
async function cargarDolar(){
  try{
    const d = await (await fetch('/api/dolar')).json();
    const tipos = ["oficial","blue","tarjeta","mep","ccl","cripto"];
    const sel = d.filter(x => tipos.includes((x.casa||x.nombre||'').toLowerCase()));
    $('#cards-dolar').innerHTML = sel.map(row=>{
      const nombre = (row.casa || row.nombre || 'D√ìLAR').toUpperCase();
      const venta = fmt(row.venta || row.venta_promedio || 0);
      const compra = fmt(row.compra || row.compra_promedio || 0);
      return `<div class="chip"><b>${nombre}</b>
                <div class="mut">venta <b style="color:#fff">$ ${venta}</b></div>
                <div class="mut">compra <b style="color:#fff">$ ${compra}</b></div>
              </div>`;
    }).join('') || '<div class="mut">Sin datos</div>';
  }catch(e){
    $('#cards-dolar').innerHTML = '<div class="mut">No se pudo cargar el d√≥lar.</div>';
  }
}

// ======= PARES: USDT/ARS + (BTC/USDT, ETH/USDT, SOL/USDT) =======
const PARES = [
  // se mantiene este en ARS
  { asset:'usdt', fiat:'ars', title:'USDT/ARS' },
  // el resto ahora en USDT
  { asset:'btc',  fiat:'usdt', title:'BTC/USDT' },
  { asset:'eth',  fiat:'usdt', title:'ETH/USDT' },
  { asset:'sol',  fiat:'usdt', title:'SOL/USDT' },
];

function renderPairCard(title, rows){
  const tbody = rows.map(r => `
    <tr>
      <td style="color:#9ecbff;font-weight:700">${r.ex.toUpperCase()}</td>
      <td>${title}</td>
      <td class="right">${r.bid!=null? '$ '+fmt(r.bid): '‚Äî'}</td>
      <td class="right">${r.ask!=null? '$ '+fmt(r.ask): '‚Äî'}</td>
    </tr>`).join('');
  return `
    <div class="pair-card">
      <div class="pair-title"><b>${title}</b><span class="mut">${rows.length} exchanges</span></div>
      <table>
        <thead><tr><th>Exchange</th><th>Par</th><th class="right">Compra</th><th class="right">Venta</th></tr></thead>
        <tbody>${tbody || `<tr><td colspan="4" class="mut">Sin datos</td></tr>`}</tbody>
      </table>
    </div>`;
}

async function cargarPares(){
  const status = $('#pares-status');
  const container = $('#pairs');
  status.textContent = 'API: comprobando‚Ä¶';
  container.innerHTML = '';

  for (const p of PARES){
    try{
      const data = await (await fetch(`/api/criptoya/${p.asset}/${p.fiat}/1`)).json();
      const exs = Object.keys(data).filter(k=>data[k]).sort();
      const rows = exs.map(ex => ({
        ex,
        bid: data[ex]?.totalBid,
        ask: data[ex]?.totalAsk
      }));
      container.insertAdjacentHTML('beforeend', renderPairCard(p.title, rows));
    }catch(e){
      container.insertAdjacentHTML('beforeend', renderPairCard(p.title, []));
    }
  }
  status.textContent = 'API: ok';
}

// ======= GR√ÅFICO + INDICADORES + SE√ëALES =======
const API = "https://api.binance.com/api/v3/klines";
let chart, candleSeries, ema20Series, ema50Series, lastData=[];

function ensureChart(){
  if(chart) return;
  chart = LightweightCharts.createChart(document.getElementById('chartWrap'), {
    layout:{background:{type:'solid',color:'#0f1115'}, textColor:'#dfe3ea'},
    grid:{vertLines:{color:'#1d2128'}, horzLines:{color:'#1d2128'}},
    rightPriceScale:{borderColor:'#2a2d34'},
    timeScale:{borderColor:'#2a2d34'}
  });
  candleSeries = chart.addCandlestickSeries();
  ema20Series  = chart.addLineSeries({ lineWidth:2 });
  ema50Series  = chart.addLineSeries({ lineWidth:2 });
}

async function getKlines(symbol, interval, limit=500){
  const res = await fetch(`${API}?symbol=${symbol}&interval=${interval}&limit=${limit}`);
  if(!res.ok) throw new Error('Binance API error');
  const raw = await res.json();
  return raw.map(k=>({time:Math.floor(k[0]/1000), open:+k[1], high:+k[2], low:+k[3], close:+k[4], volume:+k[5]}));
}

// ---- Indicadores
const SMA = (arr,p)=> arr.map((_,i)=> i<p-1? null : arr.slice(i-p+1,i+1).reduce((a,b)=>a+b,0)/p );
const EMA = (arr,p)=>{ const k=2/(p+1); const out=[]; let ema=arr[0]; for(let i=0;i<arr.length;i++){ ema=i? arr[i]*k+ema*(1-k):arr[i]; out.push(ema);} return out; };
function RSI(closes, period=14){
  const rsi = new Array(closes.length).fill(null);
  let gains=0, losses=0;
  for(let i=1;i<=period;i++){ const ch=closes[i]-closes[i-1]; if(ch>=0) gains+=ch; else losses+=-ch; }
  let avgG=gains/period, avgL=losses/period;
  rsi[period]= 100 - 100/(1+(avgG/(avgL||1e-9)));
  for(let i=period+1;i<closes.length;i++){
    const ch=closes[i]-closes[i-1];
    const g=ch>0?ch:0, l=ch<0?-ch:0;
    avgG=(avgG*(period-1)+g)/period;
    avgL=(avgL*(period-1)+l)/period;
    rsi[i]= 100 - 100/(1+(avgG/(avgL||1e-9)));
  }
  return rsi;
}
function MACD(closes, fast=12, slow=26, signal=9){
  const emaF=EMA(closes,fast), emaS=EMA(closes,slow);
  const macd=emaF.map((v,i)=>v-emaS[i]);
  const sig = EMA(macd.slice(slow-1), signal);
  const alignedSig = Array(slow-1).fill(null).concat(sig);
  const hist= macd.map((v,i)=> alignedSig[i]==null? null : v-alignedSig[i]);
  return { macd, signal:alignedSig, hist };
}
function ATR(highs,lows,closes, period=14){
  const tr=highs.map((h,i)=> i? Math.max(h-lows[i], Math.abs(h-closes[i-1]), Math.abs(lows[i]-closes[i-1])) : h-lows[i]);
  return SMA(tr, period);
}
function trendAndSignal(closes, ema20, ema50, rsi, macd){
  const n=closes.length-1;
  const up = ema20[n]>ema50[n] && rsi[n]>55 && macd.hist[n]>0;
  const dn = ema20[n]<ema50[n] && rsi[n]<45 && macd.hist[n]<0;
  const trend = ema20[n]>ema50[n]? "ALCISTA" : ema20[n]<ema50[n]? "BAJISTA":"LATERAL";
  let signal="NEUTRO", note="Mercado sin confirmaci√≥n clara.";
  if(up){ signal="COMPRA"; note="EMA20>EMA50, RSI>55 y MACD+."; }
  if(dn){ signal="VENTA";  note="EMA20<EMA50, RSI<45 y MACD-."; }
  return {signal, trend, note};
}

function setChartData(candles, ema20, ema50){
  ensureChart();
  candleSeries.setData(candles.map(c=>({time:c.time,open:c.open,high:c.high,low:c.low,close:c.close})));
  ema20Series.setData(candles.map((c,i)=> ema20[i]==null? null : {time:c.time, value:ema20[i]}).filter(Boolean));
  ema50Series.setData(candles.map((c,i)=> ema50[i]==null? null : {time:c.time, value:ema50[i]}).filter(Boolean));
  chart.timeScale().fitContent();
}

async function loadAndAnalyze(){
  const symbol = $('#sym').value, interval = $('#tf').value;
  $('#signalText').textContent = 'Cargando‚Ä¶'; $('#atText').textContent = 'Procesando‚Ä¶';
  try{
    const candles = await getKlines(symbol,interval,500);
    lastData=candles;
    const closes=candles.map(c=>c.close), highs=candles.map(c=>c.high), lows=candles.map(c=>c.low);
    const ema20=EMA(closes,20), ema50=EMA(closes,50), rsi14=RSI(closes,14), macd=MACD(closes), atr14=ATR(highs,lows,closes,14);
    setChartData(candles, ema20, ema50);

    const sig=trendAndSignal(closes,ema20,ema50,rsi14,macd);
    const last=candles.at(-1), prev=candles.at(-2);
    const change=((last.close-prev.close)/prev.close)*100;
    $('#signalText').innerHTML =
      `<b>${symbol} (${interval})</b> ‚Üí <b>${sig.signal}</b> ¬∑ Tendencia: <b>${sig.trend}</b><br>`+
      `Precio: <b>$${fmt(last.close)}</b> | Var √∫ltima vela: ${fmt(change,2)}%<br>`+
      `<span class="mut">${sig.note}</span>`;

    const idx=closes.length-1;
    const sup=Math.min(...lows.slice(-20)), res=Math.max(...highs.slice(-20));
    $('#atText').innerHTML =
      `EMA20: <b>${fmt(ema20[idx])}</b> ¬∑ EMA50: <b>${fmt(ema50[idx])}</b> | `+
      `RSI14: <b>${fmt(rsi14[idx])}</b> ¬∑ `+
      `MACD: <b>${fmt(macd.macd[idx])}</b> ¬∑ Se√±al: <b>${fmt(macd.signal[idx])}</b> ¬∑ Hist: <b>${fmt(macd.hist[idx])}</b> ¬∑ `+
      `ATR14: <b>${fmt(atr14[idx])}</b> ¬∑ `+
      `Soporte ‚âà <b>${fmt(sup)}</b> ¬∑ Resistencia ‚âà <b>${fmt(res)}</b>`;
  }catch(e){
    console.error(e);
    $('#signalText').textContent = 'No se pudo cargar el gr√°fico.';
    $('#atText').textContent = '‚Äî';
  }
}

// ======= Chat de An√°lisis (sin API) =======
function genInformeLocal(){
  if(!lastData.length){ $('#aiOut').value='Carg√° el gr√°fico primero.'; return; }
  const symbol=$('#sym').value, tf=$('#tf').value;
  const closes=lastData.map(c=>c.close), highs=lastData.map(c=>c.high), lows=lastData.map(c=>c.low);
  const ema20=EMA(closes,20), ema50=EMA(closes,50), rsi14=RSI(closes,14), macd=MACD(closes), atr14=ATR(highs,lows,closes,14);
  const {signal,trend,note}=trendAndSignal(closes,ema20,ema50,rsi14,macd);
  const idx=closes.length-1;
  const sup=Math.min(...lows.slice(-20)), res=Math.max(...highs.slice(-20));
  const price=closes[idx], riskPct = Math.max(0, Math.min(100, Number($('#risk').value||0)));
  const sidePref = $('#sidePref').value;

  let side = signal==="COMPRA" ? "LONG" : signal==="VENTA" ? "SHORT" : "NEUTRO";
  if(sidePref==="long") side = "LONG";
  if(sidePref==="short") side = "SHORT";

  // niveles sugeridos simples
  const stop = side==="LONG" ? Math.min(sup, price - 2*(atr14[idx]||0)) : Math.max(res, price + 2*(atr14[idx]||0));
  const tp1  = side==="LONG" ? price + 1.5*(atr14[idx]||0) : price - 1.5*(atr14[idx]||0);
  const tp2  = side==="LONG" ? price + 3*(atr14[idx]||0)   : price - 3*(atr14[idx]||0);

  const txt =
`Par: ${symbol} | TF: ${tf}
Precio actual: ${fmt(price)}
Tendencia: ${trend} | Se√±al: ${signal} (${note})

Indicadores:
- EMA20: ${fmt(ema20[idx])} | EMA50: ${fmt(ema50[idx])}
- RSI14: ${fmt(rsi14[idx])} ${rsi14[idx]>70?'(sobrecompra)':rsi14[idx]<30?'(sobreventa)':'(neutral)'}
- MACD: ${fmt(macd.macd[idx])} | Se√±al: ${fmt(macd.signal[idx])} | Hist: ${fmt(macd.hist[idx])}
- ATR14: ${fmt(atr14[idx])}
- Soporte zona ‚âà ${fmt(sup)} | Resistencia zona ‚âà ${fmt(res)}

Plan sugerido (${sidePref==='auto'?'auto':sidePref.toUpperCase()} ‚Üí ${side}):
- Entrada: mercado (confirmaci√≥n con cierre por encima/debajo de EMA20 seg√∫n bias)
- Stop ${side==='LONG'?'debajo':'encima'}: ${fmt(stop)}
- Take Profit 1: ${fmt(tp1)} | Take Profit 2: ${fmt(tp2)}
- Gesti√≥n: mover stop a break-even en TP1; cerrar 50% en TP1 y 50% en TP2

Riesgo:
- Riesgo por trade: ${riskPct ? riskPct+'% del capital' : 'no especificado'}
- Sugerencia: no superar 1‚Äì2% por operaci√≥n; evitar operar en rango (RSI 45‚Äì55 y EMA20‚âàEMA50)

Notas:
- Este informe es educativo y se genera localmente con datos p√∫blicos (sin API key).
- Valid√° liquidez, horarios y noticias antes de ejecutar operaciones.`;
  $('#aiOut').value = txt;
}

// ======= Scanner =======
const WATCHLIST = ['BTCUSDT','ETHUSDT','BNBUSDT','SOLUSDT','XRPUSDT','ADAUSDT','DOGEUSDT','MATICUSDT','LINKUSDT','TONUSDT'];
async function scan(interval='1h'){
  $('#scanInfo').textContent = 'Escaneando‚Ä¶';
  $('#scanBody').innerHTML='';
  for(const s of WATCHLIST){
    try{
      const c = await getKlines(s, interval, 300);
      const closes=c.map(v=>v.close), highs=c.map(v=>v.high), lows=c.map(v=>v.low);
      const ema20=EMA(closes,20), ema50=EMA(closes,50), rsi14=RSI(closes,14), macd=MACD(closes);
      const sig=trendAndSignal(closes,ema20,ema50,rsi14,macd);
      const pill = (txt,bg)=>`<span style="background:${bg};color:white;border-radius:6px;padding:2px 6px;font-size:.85rem">${txt}</span>`;
      const pillSig = sig.signal==="COMPRA"? pill("COMPRA","#18a05e") : sig.signal==="VENTA"? pill("VENTA","#d9534f") : pill("NEUTRO","#6c757d");
      const pillTr  = sig.trend==="ALCISTA"? pill("ALCISTA","#0d6efd") : sig.trend==="BAJISTA"? pill("BAJISTA","#7952b3") : pill("LATERAL","#6c757d");
      $('#scanBody').insertAdjacentHTML('beforeend',
        `<tr style="border-bottom:1px solid var(--line)"><td>${s}</td><td>${interval}</td><td>${pillTr}</td><td>${pillSig}</td><td>${rsi14.at(-1)?.toFixed(1)??'-'}</td><td class="mut">${sig.note}</td></tr>`
      );
    }catch(e){
      $('#scanBody').insertAdjacentHTML('beforeend', `<tr><td>${s}</td><td>${interval}</td><td colspan="3">Error de API</td><td></td></tr>`);
    }
  }
  $('#scanInfo').textContent = 'Listo.';
}

// ======= Eventos =======
$('#btnLoad').addEventListener('click', loadAndAnalyze);
$('#btnScan').addEventListener('click', ()=> scan($('#tf').value));
$('#btnInforme').addEventListener('click', genInformeLocal);

// ======= Arranque =======
cargarDolar();
cargarPares();
loadAndAnalyze();
</script>
</body>
</html>
