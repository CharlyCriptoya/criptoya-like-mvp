<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0b0f16" />
  <title>Arbolito ‚Äî Cotizaciones</title>
  <style>
    :root{
      --text:#e5e7eb;--muted:#a1a1aa;--line:rgba(255,255,255,.08);--cardBg:rgba(10,13,20,.84);
      --chipBg:rgba(255,255,255,.06);--ok:#22c55e;--bad:#ef4444;--accent:#60a5fa
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      background:url('Muro.jpg') center/cover fixed no-repeat, url('public/Muro.jpg') center/cover fixed no-repeat, #0b0f16;
      overflow-x:hidden
    }
    .page{max-width:480px;margin:0 auto;padding:12px}
    h1{margin:6px 0 10px;font-size:18px;letter-spacing:.2px}
    .card{background:var(--cardBg);border:1px solid var(--line);border-radius:14px;padding:10px}
    .grid-dolar{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .dl-title{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:4px;font-variant-numeric:tabular-nums}
    .row span:first-child{color:var(--muted);font-size:12px}
    .updated{margin-top:4px;font-size:11px;color:var(--muted)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .tab{
      padding:11px 14px;border-radius:999px;background:#fff;color:#0b0f16;border:1px solid #e5e7eb;
      font-size:14px;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.25)
    }
    .tab.active{background:#f3f4f6;border-color:#cbd5e1;box-shadow:0 0 0 2px rgba(255,255,255,.25) inset}
    .chip{font-size:11px;padding:2px 8px;border-radius:999px;background:var(--chipBg);border:1px solid var(--line);color:var(--muted)}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{padding:10px 10px;text-align:left}
    th{font-size:11px;color:var(--muted);border-bottom:1px solid var(--line)}
    tbody tr{background:var(--cardBg);border:1px solid var(--line)}
    tbody td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .price{font-variant-numeric:tabular-nums}
    .green{color:var(--ok)} .red{color:var(--bad)}
    .meta{margin:8px 2px 2px;color:var(--muted);font-size:11px}
    .skeleton{
      background:linear-gradient(90deg,rgba(255,255,255,.04) 25%,rgba(255,255,255,.08) 37%,rgba(255,255,255,.04) 63%);
      background-size:400% 100%;animation:sh 1.2s ease infinite;border-radius:10px
    }
    @keyframes sh{0%{background-position:100% 50%}100%{background-position:0 50%}}
    a{color:var(--accent);text-decoration:none}
    /* ‚Äî‚Äî‚Äî Widget de gr√°ficos & IA ‚Äî‚Äî‚Äî */
    .ai-wrap{margin-top:12px}
    .ai-grid{display:grid;gap:10px}
    @media(min-width:520px){.ai-grid{grid-template-columns:1fr}}
    .ai-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .ai-toolbar input,.ai-toolbar select{
      background:rgba(255,255,255,.08);border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px
    }
    .btn{padding:9px 12px;border:1px solid var(--line);background:var(--chipBg);color:var(--text);border-radius:10px;cursor:pointer}
    .btn.primary{background:#fff;color:#111;border-color:#e5e7eb;font-weight:700}
    #chart{height:320px}
    .note{font-size:11px;color:var(--muted);margin-top:6px}
    .coin{width:16px;height:16px;vertical-align:-3px;border-radius:999px;margin-right:6px;background:#111;object-fit:cover}
    .badge{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid var(--line);background:var(--chipBg);margin-left:6px}
    .ai-out{white-space:pre-wrap;background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:13px;margin-top:8px}
    /* stats */
    .stats24h{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0;font-size:12px}
    .stat-box{flex:1;min-width:120px;background:var(--cardBg);border:1px solid var(--line);border-radius:10px;padding:8px}
    .ranges{display:flex;gap:6px;margin-top:6px}
    .range-btn{flex:1;padding:6px 8px;border:1px solid var(--line);border-radius:6px;background:var(--chipBg);cursor:pointer;font-size:12px}
    .range-btn.active{background:#fff;color:#111;font-weight:700}
  </style>
</head>
<body>
  <div class="page">
    <section>
      <h1>üí± Cotizaciones del D√≥lar (ARS)</h1>
      <div id="dolares" class="grid-dolar">
        <div class="card skeleton" style="height:70px"></div><div class="card skeleton" style="height:70px"></div>
        <div class="card skeleton" style="height:70px"></div><div class="card skeleton" style="height:70px"></div>
        <div class="card skeleton" style="height:70px"></div><div class="card skeleton" style="height:70px"></div>
      </div>
    </section>

    <section style="margin-top:12px">
      <div style="display:flex;align-items:center;gap:8px">
        <h1 style="margin:0">ü™ô Pares</h1>
        <span id="apiStatus" class="chip">API: comprobando‚Ä¶</span>
      </div>
      <div id="tabs" class="tabs"></div>

      <div class="card">
        <table>
          <thead>
            <tr><th>Exchange</th><th>Par</th><th>Compra</th><th>Venta</th><th>24h</th><th>Act.</th></tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" class="skeleton" style="height:46px"></td></tr>
            <tr><td colspan="6" class="skeleton" style="height:46px"></td></tr>
            <tr><td colspan="6" class="skeleton" style="height:46px"></td></tr>
          </tbody>
        </table>
      </div>
      <div class="meta">
        D√≥lar por <a href="https://dolarapi.com" target="_blank" rel="noopener">dolarapi</a>.
        Cripto por <a href="https://criptoya.com" target="_blank" rel="noopener">CriptoYa</a> y APIs oficiales (con fallback).
      </div>
    </section>

    <!-- ‚Äî‚Äî‚Äî WIDGET NUEVO: Gr√°fico + IA ‚Äî‚Äî‚Äî -->
    <section class="ai-wrap">
      <h1 style="margin:0 0 6px">üìà Gr√°fico & ü§ñ An√°lisis</h1>
      <div class="card">
        <div class="ai-grid">
          <div>
            <div class="ai-toolbar">
              <select id="wgExchange" aria-label="Exchange">
                <option value="binance">Binance</option>
                <option value="okx">OKX</option>
                <option value="bybit">Bybit</option>
                <option value="kucoin">KuCoin</option>
                <option value="mexc">MEXC</option>
                <option value="bingx">BingX</option>
              </select>
              <input id="wgBase" placeholder="BTC, ETH, SOL‚Ä¶" size="8" aria-label="Base" />
              <select id="wgQuote" aria-label="Cotizaci√≥n">
                <option value="USDT">USDT</option>
              </select>
              <select id="wgTF" aria-label="Timeframe">
                <option value="1m">1m</option>
                <option value="5m">5m</option>
                <option value="15m">15m</option>
                <option value="1h">1h</option>
                <option value="4h">4h</option>
                <option value="1d">1d</option>
              </select>
              <button class="btn primary" id="btnLoad">Cargar gr√°fico</button>
              <button class="btn" id="btnDownload">Descargar PNG</button>
            </div>

            <!-- üìä Stats 24h -->
            <div id="stats24h" class="stats24h"></div>

            <!-- ‚è± Rangos -->
            <div class="ranges" role="group" aria-label="Rangos r√°pidos">
              <button class="range-btn active" data-tf="1m">1m</button>
              <button class="range-btn" data-tf="5m">5m</button>
              <button class="range-btn" data-tf="15m">15m</button>
              <button class="range-btn" data-tf="1h">1h</button>
              <button class="range-btn" data-tf="4h">4h</button>
              <button class="range-btn" data-tf="1d">1d</button>
            </div>

            <div id="chart" aria-label="Gr√°fico de velas"></div>
            <div class="note">Tip: el Exchange del gr√°fico es el que elijas arriba. En la tabla de ‚ÄúPares‚Äù, el nombre del exchange abre su p√°gina de trading del par.</div>
          </div>

          <div>
            <div class="ai-toolbar">
              <input id="openaiKey" placeholder="Tu OpenAI API Key (sk-‚Ä¶)" style="flex:1;min-width:220px" />
              <button class="btn" id="btnSaveKey">Guardar clave</button>
            </div>
            <button class="btn primary" id="btnAI">Analizar con IA</button>
            <span class="badge" id="autoSigToggle" role="switch" aria-checked="false" style="cursor:pointer">Auto-se√±ales: OFF</span>
            <div class="ai-out" id="aiOut">
              Carg√° un gr√°fico y opcionalmente peg√° tu clave de OpenAI para obtener un an√°lisis. Las auto-se√±ales usan EMA20/EMA50 y RSI14 locales (no IA).
            </div>
            <div class="note">‚ö†Ô∏è No es asesoramiento financiero. Us√° gesti√≥n de riesgo.</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Librer√≠a de gr√°ficos (canvas) -->
  <script src="https://unpkg.com/lightweight-charts@4.2.3/dist/lightweight-charts.standalone.production.js"></script>

  <script>
  /* ===== Utilidades ===== */
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const nfUS=new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});

  /* ===== Stats 24h ===== */
  function updateStats24h(data){
    if(!data?.length) return;
    const closes=data.map(d=>d.c);
    const highs=data.map(d=>d.h);
    const lows=data.map(d=>d.l);
    const last=closes[closes.length-1];
    const max=Math.max(...highs);
    const min=Math.min(...lows);
    const chg=((last-closes[0])/closes[0])*100;
    $('#stats24h').innerHTML=`
      <div class="stat-box"><strong>√öltimo</strong><br>${nfUS.format(last)}</div>
      <div class="stat-box"><strong>M√°x 24h</strong><br>${nfUS.format(max)}</div>
      <div class="stat-box"><strong>M√≠n 24h</strong><br>${nfUS.format(min)}</div>
      <div class="stat-box"><strong>Cambio</strong><br>${chg.toFixed(2)}%</div>`;
  }

  /* ====== WIDGET: Gr√°ficos ====== */
  let chart, candleSeries, lastCandles=[];
  const chartEl = $('#chart');

  function initChart(){
    chart?.remove();
    chart = LightweightCharts.createChart(chartEl,{
      width: chartEl.clientWidth, height: 320,
      layout:{background:{type:'solid',color:'transparent'},textColor:'#e5e7eb'},
      grid:{vertLines:{color:'rgba(255,255,255,0.06)'},horzLines:{color:'rgba(255,255,255,0.06)'}},
      rightPriceScale:{borderVisible:false}, timeScale:{borderVisible:false}
    });
    candleSeries = chart.addCandlestickSeries();
    new ResizeObserver(()=> chart.applyOptions({width: chartEl.clientWidth}) ).observe(chartEl);
  }

  function mapToLWC(data){ return data.map(d=>({time: Math.floor(d.t/1000), open:d.o, high:d.h, low:d.l, close:d.c})); }

  async function fetchKlines(exchange, base, quote, tf){
    try{
      const j=await fetch(`https://api.binance.com/api/v3/klines?symbol=${base.toUpperCase()}${quote.toUpperCase()}&interval=${tf}&limit=300`);
      const arr=await j.json();
      return arr.map(k=>({t:+k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4]}));
    }catch(e){ console.error(e); return []; }
  }

  async function loadChartFromUI(){
    const ex=$('#wgExchange').value, base=$('#wgBase').value||'BTC', quote=$('#wgQuote').value||'USDT', tf=$('#wgTF').value||'1m';
    $('#aiOut').textContent='Cargando velas‚Ä¶';
    const data=await fetchKlines(ex,base,quote,tf);
    lastCandles=data;
    initChart();
    candleSeries.setData(mapToLWC(data));
    updateStats24h(data); // actualiza stats
    $('#aiOut').textContent=`Listo: ${ex.toUpperCase()} ${base}/${quote} ${tf}. Velas: ${data.length}.`;
  }

  /* Eventos */
  function attachWidgetEvents(){
    $('#btnLoad').onclick=loadChartFromUI;
    $('#btnDownload').onclick=()=>{
      const cv = chartEl.querySelector('canvas'); if(!cv) return;
      const link=document.createElement('a'); link.download=`chart_${Date.now()}.png`; link.href=cv.toDataURL('image/png'); link.click();
    };
    $$('.range-btn').forEach(btn=>{
      btn.onclick=()=>{
        $$('.range-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        $('#wgTF').value=btn.dataset.tf;
        loadChartFromUI();
      };
    });
  }

<script>
// ...todo tu c√≥digo anterior se queda igual...

(async function(){
  initChart();
  attachWidgetEvents();

  // Defaults seguros y auto-carga al abrir
  try {
    const ex = document.getElementById('wgExchange');
    const base = document.getElementById('wgBase');
    const quote = document.getElementById('wgQuote');
    const tf = document.getElementById('wgTF');

    if (ex)   ex.value   = 'binance';
    if (base) base.value = (base.value || 'BTC');
    if (quote) quote.value = 'USDT';
    if (tf)   tf.value   = '1m';

    await loadChartFromUI();          // üëà pinta el gr√°fico y los stats
  } catch (e) {
    console.error('init/autoload error:', e);
    const out = document.getElementById('aiOut');
    if (out) out.textContent = 'No se pudo auto-cargar el gr√°fico. Prob√° tocar "Cargar gr√°fico".';
  }
})();
</script>
