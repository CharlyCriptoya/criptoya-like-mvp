<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CriptoYA-like</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 1rem;
    }
    h2 { margin-top: 0; }
    ul.quotes { list-style: none; padding: 0; margin: 0; }
    .quote-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: .6rem .8rem; border-bottom: 1px solid #2a2a2a;
    }
    .quote-left { display: flex; align-items: center; gap: .6rem; }
    .exch-logo { width: 22px; height: 22px; border-radius: 6px; object-fit: cover; }
    .exch-name { font-weight: 700; }
    .quote-right { display: flex; flex-direction: column; align-items: flex-end; }
    .price { font-weight: 800; }
    .sub { opacity: .7; font-size: .9em; }
    /* Colores especiales */
    .best-buy { color: #00c853; }  /* verde */
    .best-sell { color: #d50000; } /* rojo */

    /* ====== ESTILOS DEL WIDGET (aislados) ====== */
    .ta-card{background:#161a22;border:1px solid #222836;border-radius:12px;padding:12px;margin-top:16px}
    .ta-title{margin:0 0 8px;font-weight:800;color:#cfd6e4}
    .ta-row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .ta-chip,.ta-btn{
      padding:8px 12px;border-radius:999px;border:1px solid #2a2f3a;background:#1d2330;color:#cfd6e4;cursor:pointer
    }
    .ta-chip.active{background:#3ea6ff;color:#081018;border-color:transparent}
    .ta-btn.primary{background:#3ea6ff;color:#081018;border-color:transparent}
    #tvbox{height:420px;border:1px solid #212736;border-radius:8px;overflow:hidden}
    .ta-kv{display:flex;justify-content:space-between;border-bottom:1px solid #212736;padding:6px 0}
    .ta-kv:last-child{border-bottom:none}
    .ta-green{color:#00c853}.ta-red{color:#d50000}.ta-mut{color:#9aa4b2}
    .ta-small{font-size:.9em}
    .ta-input{flex:1;padding:8px;border-radius:8px;border:1px solid #2a2f3a;background:#0f1115;color:#e7e9ee}
  </style>
</head>
<body>
  <h2>USDT/ARS</h2>
  <ul id="quotes-list" class="quotes"></ul>

  <!-- ========= WIDGET: GR√ÅFICO + AN√ÅLISIS ========= -->
  <!-- TradingView -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <section class="ta-card">
    <h3 class="ta-title">Gr√°fico + An√°lisis t√©cnico</h3>

    <!-- Favoritos -->
    <div id="taFav" class="ta-row"></div>

    <!-- Timeframes -->
    <div id="taTF" class="ta-row"></div>

    <!-- Gr√°fico -->
    <div id="tvbox"></div>

    <!-- Acciones -->
    <div class="ta-row" style="margin:10px 0 6px">
      <button id="btnShow" class="ta-btn">Mostrar gr√°fico</button>
      <button id="btnTA" class="ta-btn">Hacer an√°lisis t√©cnico</button>
      <button id="btnReco" class="ta-btn">Recomendaciones (TA)</button>
      <a id="btnNews" class="ta-btn" target="_blank" rel="noopener">Noticias</a>
    </div>

    <!-- Otra moneda -->
    <div class="ta-row" style="align-items:center">
      <input id="taOther" class="ta-input" placeholder="Otra moneda (ej. ARBUSDT, PEPEUSDT)">
      <button id="btnOther" class="ta-btn">Analizar</button>
    </div>

    <!-- Resultado -->
    <div id="taResult" class="ta-card" style="margin:12px 0 0; padding:10px; display:none">
      <div class="ta-kv"><span>Sesgo / Tendencia</span><span id="taBias"></span></div>
      <div class="ta-kv"><span>Entrada (ref.)</span><span id="taEntry" class="price">$ ‚Äî</span></div>
      <div class="ta-kv"><span>Stop-loss</span><span id="taSL" class="price ta-red">$ ‚Äî</span></div>
      <div class="ta-kv"><span>Take-profit 1√ó / 1.5√ó / 2√ó ATR</span><span id="taTP" class="price ta-green">$ ‚Äî</span></div>
      <div id="taInd" class="ta-small ta-mut" style="margin-top:6px">RSI, EMA20/50, MACD, ATR</div>
      <div id="taRecoText" class="ta-small" style="margin-top:8px"></div>
      <div class="ta-small ta-mut" style="margin-top:8px">Uso educativo. No es consejo financiero.</div>
    </div>
  </section>
  <!-- ========= /WIDGET ========= -->

  <script>
    /* ========== LO TUYO (igual que antes) ========== */
    const norm = s => String(s || '').toLowerCase().replace(/\s+/g,'').trim();
    const FALLBACK_LOGO = 'https://upload.wikimedia.org/wikipedia/commons/3/3f/Placeholder_view_vector.svg';

    const LOGOS = {
      ripio: "https://cryptologos.cc/logos/ripio-logo.png",
      satoshitango: "https://cryptologos.cc/logos/bitcoin-btc-logo.png",
      lemoncash: "https://seeklogo.com/images/L/lemon-cash-logo-0C3D8E1E3E-seeklogo.com.png",
      buenbit: "https://pbs.twimg.com/profile_images/1564998121880360960/LqR37f-v_400x400.jpg",
      letsbit: "https://pbs.twimg.com/profile_images/1697329473060747264/S9WnC6bE_400x400.jpg",
      fiwind: "https://play-lh.googleusercontent.com/0g8Y0uJf4YVb1rZB3T7mVdSx3QZ2Q1QfK8e3uZ0O9s2h=s180",
      binance: "https://cryptologos.cc/logos/binance-coin-bnb-logo.png"
      // pod√©s seguir agregando
    };

    function renderQuotes(quotes) {
      const list = document.getElementById("quotes-list");
      list.innerHTML = "";

      if (!quotes.length) {
        list.innerHTML = "<li>No hay cotizaciones</li>";
        return;
      }

      // calcular mejor compra y mejor venta
      const bestBuy = Math.min(...quotes.map(q => q.buy));
      const bestSell = Math.max(...quotes.map(q => q.sell));

      quotes.forEach(q => {
        const li = document.createElement("li");
        li.className = "quote-row";

        const buyClass = q.buy === bestBuy ? "best-buy" : "";
        const sellClass = q.sell === bestSell ? "best-sell" : "";

        const logo = LOGOS[norm(q.exchange)] || FALLBACK_LOGO;

        li.innerHTML = `
          <div class="quote-left">
            <img class="exch-logo" src="${logo}" alt="">
            <span class="exch-name">${q.exchange}</span>
          </div>
          <div class="quote-right">
            <span class="price ${buyClass}">$ ${q.buy.toFixed(2)}</span>
            <span class="sub ${sellClass}">$ ${q.sell.toFixed(2)}</span>
          </div>
        `;
        list.appendChild(li);
      });
    }

    // üîß Datos de ejemplo (reemplaz√° por fetch a la API de CriptoYA)
    const ejemplo = [
      {exchange: "Ripio", buy: 1395, sell: 1363},
      {exchange: "SatoshiTango", buy: 1397, sell: 1371},
      {exchange: "LemonCash", buy: 1404, sell: 1343},
      {exchange: "Buenbit", buy: 1386, sell: 1364},
      {exchange: "LetsBit", buy: 1379, sell: 1351},
      {exchange: "Binance", buy: 1380, sell: 1364}
    ];
    renderQuotes(ejemplo);

    /* ========== WIDGET: GR√ÅFICO + TA (autocontenido) ========== */
    const FAVORITOS = ['BTCUSDT','ETHUSDT','SOLUSDT','BNBUSDT'];
    const TF_LIST   = ['5m','15m','30m','1h','4h','6h','1d'];
    const TV_MAP    = {'5m':'5','15m':'15','30m':'30','1h':'60','4h':'240','6h':'360','1d':'D'};

    const st = { symbol:'BTCUSDT', tf:'15m' };

    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    function drawChips(){
      const fav = $('#taFav'); fav.innerHTML='';
      FAVORITOS.forEach(sym=>{
        const b = document.createElement('button');
        b.className = 'ta-chip'+(sym===st.symbol?' active':'');
        b.textContent = sym.replace('USDT','');
        b.onclick = () => { st.symbol=sym; drawChips(); $('#taResult').style.display='none'; setNews(); };
        fav.appendChild(b);
      });
      const tf = $('#taTF'); tf.innerHTML='';
      TF_LIST.forEach(v=>{
        const b = document.createElement('button');
        b.className = 'ta-chip'+(v===st.tf?' active':'');
        b.textContent = v;
        b.onclick = () => { st.tf=v; drawChips(); $('#taResult').style.display='none'; };
        tf.appendChild(b);
      });
    }

    function mountTV(){
      $('#tvbox').innerHTML='';
      new TradingView.widget({
        container_id: 'tvbox', autosize: true, width:'100%', height:420,
        symbol: `BINANCE:${st.symbol}`, interval: TV_MAP[st.tf] || '15',
        timezone: 'America/Argentina/Buenos_Aires', theme:'dark', style:'1', locale:'es',
        hide_legend:false, enable_publishing:false
      });
    }

    function setNews(){
      const coin = st.symbol.replace('USDT','');
      $('#btnNews').href = `https://news.google.com/search?q=${encodeURIComponent(coin+' price OR crypto site:coindesk.com OR cointelegraph.com OR bloomberg.com OR infobae.com')}&hl=es-419&gl=AR&ceid=AR:es-419`;
    }

    // ==== Indicadores (RSI, EMA, MACD, ATR) ====
    function ema(arr,n){ const k = 2/(n+1); let e=arr[0]; const out=[e];
      for(let i=1;i<arr.length;i++){ e = arr[i]*k + e*(1-k); out.push(e); } return out; }
    function sma(arr,n){ const out=[]; let sum=0;
      for(let i=0;i<arr.length;i++){ sum+=arr[i]; if(i>=n) sum-=arr[i-n]; if(i>=n-1) out.push(sum/n); }
      while(out.length<arr.length) out.unshift(out[0]); return out; }
    function rsi(closes,n=14){ let g=0,l=0; const out=[];
      for(let i=1;i<closes.length;i++){ const d=closes[i]-closes[i-1];
        g=(g*(n-1)+Math.max(d,0))/n; l=(l*(n-1)+Math.max(-d,0))/n;
        const rs=l===0?100:g/l; out.push(100-(100/(1+rs))); }
      out.unshift(out[0]); return out; }
    function macd(cl, fast=12, slow=26, sig=9){
      const f=ema(cl,fast), s=ema(cl,slow); const line=f.map((v,i)=>v-s[i]);
      const signal=ema(line,sig); const hist=line.map((v,i)=>v-signal[i]); return {line,signal,hist};
    }
    function atr(candles,n=14){
      const trs=[candles[0].h-candles[0].l];
      for(let i=1;i<candles.length;i++){
        const h=candles[i].h, l=candles[i].l, pc=candles[i-1].c;
        trs.push(Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc)));
      }
      return sma(trs,n);
    }

    async function fetchKlines(symbol, tf, limit=300){
      const map = {'5m':'5m','15m':'15m','30m':'30m','1h':'1h','4h':'4h','6h':'6h','1d':'1d'};
      const it = map[tf] || '15m';
      const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${it}&limit=${limit}`;
      const r = await fetch(url); const j = await r.json();
      return j.map(k=>({t:k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4]}));
    }

    function decide(last, rsiV, ema20, ema50, macdL, macdS, atrV){
      let bias='Esperar';
      if(ema20>ema50 && macdL>macdS && rsiV>45 && rsiV<75) bias='Long (tendencia alcista)';
      else if(ema20<ema50 && macdL<macdS && rsiV<55 && rsiV>25) bias='Short (tendencia bajista)';
      const risk = Math.max(atrV*0.8, last*0.003); // piso ~0.3%
      let entry=+last.toFixed(4), sl=null, tp1=null,tp15=null,tp2=null;
      if(bias.startsWith('Long')){
        sl = +(last - risk).toFixed(4);
        tp1 = +(last + risk*1.0).toFixed(4);
        tp15= +(last + risk*1.5).toFixed(4);
        tp2 = +(last + risk*2.0).toFixed(4);
      }else if(bias.startsWith('Short')){
        sl = +(last + risk).toFixed(4);
        tp1 = +(last - risk*1.0).toFixed(4);
        tp15= +(last - risk*1.5).toFixed(4);
        tp2 = +(last - risk*2.0).toFixed(4);
      }
      return {bias, entry, sl, tp1, tp15, tp2};
    }

    async function runTA(){
      try{
        const ks = await fetchKlines(st.symbol, st.tf, 300);
        const closes = ks.map(k=>k.c);
        const last = closes.at(-1);
        const e20 = ema(closes,20).at(-1);
        const e50 = ema(closes,50).at(-1);
        const r14 = rsi(closes,14).at(-1);
        const {line,signal} = macd(closes);
        const a14 = atr(ks,14).at(-1);

        const {bias, entry, sl, tp1, tp15, tp2} = decide(last, r14, e20, e50, line.at(-1), signal.at(-1), a14);

        // Pintar
        $('#taResult').style.display='block';
        $('#taBias').textContent = bias;
        $('#taEntry').textContent = `$ ${entry}`;
        $('#taSL').textContent    = sl ? `$ ${sl}` : '‚Äî';
        $('#taTP').textContent    = (tp1 && tp15 && tp2) ? `$ ${tp1} / ${tp15} / ${tp2}` : '‚Äî';
        $('#taInd').textContent   = `RSI14=${r14.toFixed(1)} ‚Ä¢ EMA20=${e20.toFixed(2)} ‚Ä¢ EMA50=${e50.toFixed(2)} ‚Ä¢ MACD=${(line.at(-1)-signal.at(-1)).toFixed(4)} ‚Ä¢ ATR=${a14.toFixed(4)}`;

        // Texto de recomendaciones (claro y √∫til para trader)
        let txt = '';
        if(bias.startsWith('Long')){
          txt = `Idea long: entrada ~$ ${entry}. SL en $ ${sl}. TPs en $ ${tp1}, $ ${tp15} y $ ${tp2}. Confirmar con vela verde + volumen y mantener mientras EMA20>EMA50.`;
        }else if(bias.startsWith('Short')){
          txt = `Idea short: entrada ~$ ${entry}. SL en $ ${sl}. TPs en $ ${tp1}, $ ${tp15} y $ ${tp2}. Confirmar con rechazo en resistencias y EMA20<EMA50.`;
        }else{
          txt = `Esperar: el precio est√° mixto (RSI=${r14.toFixed(1)}, EMA20‚âà${e20.toFixed(2)}, EMA50‚âà${e50.toFixed(2)}). Buscar quiebre con volumen o pullback claro.`;
        }
        $('#taRecoText').textContent = txt;
      }catch(e){
        $('#taResult').style.display='block';
        $('#taBias').textContent = 'Error al calcular';
        $('#taEntry').textContent = '‚Äî'; $('#taSL').textContent='‚Äî'; $('#taTP').textContent='‚Äî';
        $('#taInd').textContent = 'No se pudo obtener datos de Binance.';
        $('#taRecoText').textContent = '';
      }
    }

    // Botones
    $('#btnShow').onclick = () => { mountTV(); setNews(); };
    $('#btnTA').onclick   = runTA;
    $('#btnReco').onclick = runTA;
    $('#btnOther').onclick= () => {
      const v = $('#taOther').value.trim().toUpperCase();
      if(v && /USDT$/.test(v)){ st.symbol=v; drawChips(); mountTV(); setNews(); $('#taResult').style.display='none'; }
      else alert('Us√° formato TICKERUSDT (ej. ARBUSDT, PEPEUSDT)');
    };

    // Init
    drawChips(); mountTV(); setNews();

    /* === OPCIONAL: gancho para ChatGPT (cuando quieras poner tu API key)
       async function analyzeWithGPT(contextoTexto) { ... } 
       Pod√©s llamar esa funci√≥n pasando el resumen de indicadores para que ChatGPT redacte el an√°lisis en tu estilo.
    === */
  </script>
</body>
</html>
