<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charly Cripto ‚Ä¢ MVP</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{--bg:#0e0f13;--card:#151821;--mut:#9aa3b2;--line:#232833;--txt:#e8ecf1}
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
    background:
      linear-gradient(0deg,rgba(0,0,0,.55),rgba(0,0,0,.55)),
      url('Muro.jpg') center / cover fixed no-repeat;
  }
  a{color:#9ecbff}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0 0 10px;font-size:22px}
  .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
  .mut{color:var(--mut)}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#0f1218;border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-width:160px}
  .chip b{display:block}
  .pair-grid{display:grid;gap:12px}
  @media(min-width:900px){.pair-grid{grid-template-columns:1fr 1fr}}
  .pair-card{background:#0f1218;border:1px solid var(--line);border-radius:12px;padding:12px}
  .pair-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .xcell{display:flex;align-items:center;gap:8px}
  .priceStack{display:flex;flex-direction:column;align-items:end;line-height:1.1}
  .priceUSD{color:#9aa3b2;font-size:12px}
  select,button{background:#0f1218;color:var(--txt);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:14px}
  button{cursor:pointer}
  /* Chart */
  #chartWrap{height:360px;background:#0f1115;border-radius:12px;position:relative}
  #chartContainer{width:100%;height:100%}
  /* TA box */
  #taBox{white-space:pre-wrap;background:#0f1218;border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:10px}
</style>
</head>
<body>
  <main class="wrap">
    <div style="display:flex;align-items:center;gap:10px">
      <h1 style="margin:0">Charly Cripto ‚Ä¢ MVP</h1>
    </div>
    <div class="mut">D√≥lar por <a href="https://dolarapi.com" target="_blank">dolarapi</a> ‚Ä¢ Cripto por Binance y <a href="https://criptoya.com" target="_blank">CriptoYa</a> (v√≠a backend).</div>

    <!-- D√ìLAR -->
    <section class="section">
      <div id="cards-dolar" class="chips">Cargando d√≥lar‚Ä¶</div>
    </section>

    <!-- /USDT -->
    <section class="section">
      <h2 style="margin:0 0 8px">Pares /USDT por exchange</h2>
      <div class="mut" id="usdt-status">API: comprobando‚Ä¶</div>
      <div class="pair-grid" id="usdtPairs"></div>
    </section>

    <!-- GR√ÅFICO + TA -->
    <section class="section">
      <h2 style="margin:0 0 8px">üìâ Gr√°fico (Binance) + An√°lisis t√©cnico</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px">
        <select id="sym">
          <option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option>
          <option>BNBUSDT</option><option>ADAUSDT</option><option>XRPUSDT</option>
          <option>DOGEUSDT</option><option>MATICUSDT</option><option>LINKUSDT</option>
          <option>TONUSDT</option>
        </select>
        <select id="tf">
          <option value="1m">1m</option><option value="5m">5m</option>
          <option value="15m">15m</option><option value="1h" selected>1h</option>
          <option value="4h">4h</option><option value="1d">1d</option>
        </select>
        <button id="btnLoad">Cargar gr√°fico</button>
        <button id="btnTA">An√°lisis t√©cnico</button>
      </div>
      <div id="chartWrap"><div id="chartContainer"></div></div>
      <div class="mut" style="margin-top:6px">Doble clic en el gr√°fico para ajustar la vista.</div>
      <div id="taBox" class="mut">Carg√° el gr√°fico y luego toc√° ‚ÄúAn√°lisis t√©cnico‚Äù.</div>
    </section>
  </main>

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<script>
const $ = s => document.querySelector(s);
const fmt = (n,d=2)=> Number(n).toLocaleString('es-AR',{maximumFractionDigits:d});
const fmtARS = new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0});
const fmtUSD = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2});

// ===== D√ìLAR =====
async function cargarDolar(){
  try{
    const d = await (await fetch('/api/dolar',{cache:'no-store'})).json();
    $('#cards-dolar').innerHTML =
      (d||[]).map(row=>{
        const nombre = (row.casa || row.nombre || 'D√ìLAR').toUpperCase();
        return `<div class="chip"><b>${nombre}</b>
          <div class="mut">venta <b style="color:#fff">${fmtARS.format(row.venta||0)}</b></div>
          <div class="mut">compra <b style="color:#fff">${fmtARS.format(row.compra||0)}</b></div>
        </div>`;
      }).join('') || '<div class="mut">Sin datos</div>';
  }catch{ $('#cards-dolar').innerHTML = '<div class="mut">No se pudo cargar el d√≥lar.</div>'; }
}

// ===== PRECIOS /USDT (ARS + USD) =====
async function cargarPreciosUSDT(symbol='BTCUSDT'){
  try{
    $('#usdt-status').textContent = 'API: cargando‚Ä¶';
    const r = await fetch(`/api/precios?symbol=${symbol}`,{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const { rows, usdars } = await r.json();

    const html = (rows||[]).map(row=>{
      if(row.error) return '';
      const ex = row.exchange||'‚Äî';
      const pair = row.pair||symbol;
      const arsVal = row.bid_ars ?? null;
      // USD directo si viene; si no, lo calculamos con usdars
      const usdVal = (row.bid_usd ?? (arsVal && usdars ? (arsVal / usdars) : null));
      const ars = arsVal!=null ? fmtARS.format(arsVal) : '‚Äî';
      const usd = usdVal!=null ? fmtUSD.format(usdVal) : '‚Äî';
      return `<div class="pair-card">
        <div class="pair-title">
          <div class="xcell"><span style="color:#9ecbff;font-weight:700">${ex}</span></div>
          <div class="priceStack"><span>${ars}</span><span class="priceUSD">${usd} / USDT</span></div>
        </div>
        <div class="mut">${pair}</div>
      </div>`;
    }).join('');

    $('#usdtPairs').innerHTML = html || '<div class="mut">Sin datos</div>';
    $('#usdt-status').textContent = `USDARS ref: ${usdars ? fmt(usdars,2) : '‚Äî'}`;
  }catch(e){
    console.error(e);
    $('#usdt-status').textContent = 'API: error';
    $('#usdtPairs').innerHTML = '<div class="mut">No se pudieron cargar los precios.</div>';
  }
}

// ===== GR√ÅFICO =====
let chart, series, lastData = [];
function initChart(){
  const el = document.getElementById('chartContainer');
  chart = LightweightCharts.createChart(el,{
    layout:{background:{color:'#0f1115'},textColor:'#DDD'},
    grid:{vertLines:{color:'#222'},horzLines:{color:'#222'}},
    timeScale:{borderColor:'#444'},
    rightPriceScale:{borderColor:'#444'},
    crosshair:{mode:LightweightCharts.CrosshairMode.Normal},
    handleScale:{axisPressedMouseMove:true,pinch:true},
    handleScroll:{mouseWheel:true,pressedMouseMove:true,horzTouchDrag:true}
  });
  series = chart.addCandlestickSeries({
    upColor:'#22c55e',downColor:'#ef4444',
    wickUpColor:'#22c55e',wickDownColor:'#ef4444',borderVisible:false
  });
  new ResizeObserver(()=> chart.resize(el.clientWidth, el.clientHeight)).observe(el);
  el.addEventListener('dblclick',()=> chart.timeScale().fitContent());
}

async function loadChart(symbol='BTCUSDT', interval='1h'){
  if(!chart) initChart();
  try{
    const r = await fetch(`/api/candles?symbol=${symbol}&interval=${interval}&limit=500`,{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const data = rows.map(c=>({time:c.t/1000, open:+c.o, high:+c.h, low:+c.l, close:+c.c}));
    if(!data.length) throw new Error('sin datos');
    lastData = data;
    series.setData(data);
    chart.timeScale().fitContent();
  }catch(e){
    console.error(e);
    document.getElementById('chartContainer').innerHTML =
      '<div style="color:#f66;padding:10px">No se pudo cargar el gr√°fico.</div>';
  }
}

document.getElementById('btnLoad').addEventListener('click',()=>{
  const s = document.getElementById('sym').value;
  const tf = document.getElementById('tf').value;
  loadChart(s, tf);
});

// ===== TA (SMA, EMA, MACD, RSI) =====
const SMA = (data, p, key='close')=>{
  const out=[]; let sum=0;
  for(let i=0;i<data.length;i++){
    sum += data[i][key];
    if(i>=p) sum -= data[i-p][key];
    if(i>=p-1) out.push(sum/p); else out.push(null);
  } return out;
};
const EMA = (data, p, key='close')=>{
  const k=2/(p+1); const out=[];
  let prev = data[0][key];
  for(let i=0;i<data.length;i++){
    const v = data[i][key];
    prev = i===0 ? v : (v - prev)*k + prev;
    out.push(prev);
  } return out;
};
const RSI = (data, p=14)=>{
  const out=[]; let gain=0,loss=0;
  for(let i=1;i<data.length;i++){
    const ch = data[i].close - data[i-1].close;
    const g = Math.max(ch,0), l = Math.max(-ch,0);
    if(i<=p){ gain+=g; loss+=l; out.push(null); continue; }
    gain = (gain*(p-1)+g)/p;
    loss = (loss*(p-1)+l)/p;
    const rs = loss===0 ? 100 : 100*(1 - 1/(1+gain/loss));
    out.push(rs);
  } return [null,...out];
};
const MACD = (data, f=12, s=26, sig=9)=>{
  const emaF = EMA(data,f), emaS = EMA(data,s);
  const macd = emaF.map((v,i)=> v - emaS[i]);
  const signal = EMA(macd.map((v,i)=>({close:v? v:0})), sig, 'close');
  const hist = macd.map((v,i)=> v - signal[i]);
  return {macd, signal, hist};
};

function analizar(){
  if(!lastData.length){ $('#taBox').textContent = 'Carg√° el gr√°fico primero.'; return; }
  const sym = $('#sym').value, tf = $('#tf').value;
  const closes = lastData.map(x=>({close:x.close}));
  const sma20 = SMA(closes,20).at(-1);
  const sma50 = SMA(closes,50).at(-1);
  const ema12 = EMA(closes,12).at(-1);
  const ema26 = EMA(closes,26).at(-1);
  const rsi14 = RSI(lastData,14).at(-1);
  const {macd,signal,hist} = MACD(closes,12,26,9);
  const macdV = macd.at(-1), sigV = signal.at(-1), histV = hist.at(-1);
  const last = lastData.at(-1).close;

  const trend =
    last > sma20 && sma20 > sma50 ? 'alcista' :
    last < sma20 && sma20 < sma50 ? 'bajista' : 'mixta';

  const momentum =
    rsi14>70 ? 'sobrecompra' : rsi14<30 ? 'sobreventa' : 'neutral';

  const macdTxt =
    macdV>sigV && histV>0 ? 'cruce alcista MACD sobre se√±al' :
    macdV<sigV && histV<0 ? 'cruce bajista MACD bajo se√±al' :
    'MACD sin se√±al clara';

  $('#taBox').textContent =
`S√≠mbolo: ${sym}  ‚Ä¢  TF: ${tf}
√öltimo: ${last}

Tendencia: ${trend}
SMA20: ${sma20?.toFixed(2)}  |  SMA50: ${sma50?.toFixed(2)}
EMA12: ${ema12?.toFixed(2)}  |  EMA26: ${ema26?.toFixed(2)}

Momentum: RSI(14) = ${rsi14?.toFixed(1)} (${momentum})
MACD(12,26,9): ${macdTxt}

Lectura r√°pida:
- Si precio > SMA20 > SMA50 y MACD positivo ‚Üí continuaci√≥n alcista probable.
- Si precio < SMA20 < SMA50 y MACD negativo ‚Üí riesgo de ca√≠da/continuaci√≥n bajista.
- RSI extremos (70/30) sugieren posibles pullbacks.

Esto NO es recomendaci√≥n de inversi√≥n.`;
}
document.getElementById('btnTA').addEventListener('click', analizar);

// ===== INICIO =====
(async function init(){
  cargarDolar();
  cargarPreciosUSDT('BTCUSDT');
  // Autocarga gr√°fico
  loadChart('BTCUSDT','1h');
  // refrescar precios cada 30s del s√≠mbolo actual
  setInterval(()=> cargarPreciosUSDT($('#sym')?.value || 'BTCUSDT'), 30000);
})();
</script>
</body>
</html>
