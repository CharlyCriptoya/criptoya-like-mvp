<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charly Cripto ‚Ä¢ MVP</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{--bg:#0e0f13;--card:#151821;--mut:#9aa3b2;--line:#232833;--txt:#e8ecf1}
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
    background:
      linear-gradient(0deg, rgba(0,0,0,.55), rgba(0,0,0,.55)),
      url('img/Muro.jpg') center/cover fixed no-repeat;
  }
  a{color:#9ecbff}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0 0 10px;font-size:22px}
  .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
  .mut{color:var(--mut)}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#0f1218;border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-width:160px}
  .chip b{display:block}

  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-top:1px solid #2a2f3a}
  thead th{position:sticky;top:0;background:#11141a;border-bottom:1px solid #2a2f3a;text-align:left}
  .tcard{margin-top:12px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#10131a}
  .tcap{display:flex;justify-content:space-between;align-items:center;padding:12px 12px 0 12px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 10px}
  select,button,textarea,input{background:#0f1218;color:var(--txt);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:14px}
  button{cursor:pointer}
  .xcell{display:flex;align-items:center;gap:8px}
  .xcell img.logo{width:18px;height:18px;object-fit:contain;border-radius:4px;flex:0 0 18px}
  .sub{color:#9aa3b2;font-size:12px}
  .right{text-align:right}
  #chartWrap{height:380px;background:#0f1115;border-radius:12px;position:relative}
  #chartContainer{width:100%;height:100%}
  #taBox{white-space:pre-wrap;background:#0f1218;border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:10px}
</style>
</head>
<body>
  <main class="wrap">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="logo.png" alt="Logo" style="height:40px;border-radius:8px" onerror="this.style.display='none'">
      <h1 style="margin:0">Charly Cripto ‚Ä¢ MVP</h1>
    </div>
    <div class="mut">D√≥lar por <a href="https://dolarapi.com" target="_blank">dolarapi</a> ‚Ä¢ ARS por <a href="https://criptoya.com" target="_blank">CriptoYa</a> ‚Ä¢ /USDT por exchanges (v√≠a backend).</div>

    <!-- D√ìLAR -->
    <section class="section">
      <h2 style="margin:0 0 8px">üíµ Cotizaciones del D√≥lar (ARS)</h2>
      <div id="cards-dolar" class="chips">Cargando‚Ä¶</div>
    </section>

    <!-- ARS por exchange (CriptoYa) -->
    <section class="section">
      <h2 style="margin:0 0 8px">Pares por exchange (ARS)</h2>
      <div class="mut" id="pares-status">API: comprobando‚Ä¶</div>
      <div id="arsTables"></div>
    </section>

    <!-- /USDT por exchange -->
    <section class="section">
      <h2 style="margin:0 0 8px">Pares /USDT por exchange</h2>
      <div class="mut" id="usdt-status">API: comprobando‚Ä¶</div>
      <div class="tcard">
        <div class="tcap"><div class="mut">USDARS ref: <b id="usdarsRef">‚Äî</b></div></div>
        <div style="overflow:auto">
          <table id="usdtTable">
            <thead><tr>
              <th>Exchange</th><th>Par</th><th class="right">Precio (ARS)</th><th class="right">Precio (USD)</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- GR√ÅFICO + TA -->
    <section class="section">
      <h2 style="margin:0 0 8px">üìà Gr√°fico (Binance) + An√°lisis t√©cnico</h2>
      <div class="controls">
        <select id="sym">
          <option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option>
          <option>BNBUSDT</option><option>ADAUSDT</option><option>XRPUSDT</option>
          <option>DOGEUSDT</option><option>MATICUSDT</option><option>LINKUSDT</option>
          <option>TONUSDT</option>
        </select>
        <select id="tf">
          <option value="1m">1m</option><option value="5m">5m</option>
          <option value="15m">15m</option><option value="1h" selected>1h</option>
          <option value="4h">4h</option><option value="1d">1d</option>
        </select>
        <button id="btnLoad">Cargar gr√°fico</button>
        <button id="btnTA">An√°lisis t√©cnico</button>
      </div>
      <div id="chartWrap"><div id="chartContainer"></div></div>
      <div class="mut" style="margin-top:6px">Doble clic en el gr√°fico para ajustar la vista.</div>
      <div id="taBox" class="mut">Carg√° el gr√°fico y luego toc√° ‚ÄúAn√°lisis t√©cnico‚Äù.</div>
    </section>
  </main>

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<script>
const $ = s => document.querySelector(s);
const fmt = (n,d=2)=> Number(n).toLocaleString('es-AR',{maximumFractionDigits:d});
const fmtARS = new Intl.NumberFormat('es-AR', { style:'currency', currency:'ARS', maximumFractionDigits:0 });
const fmtUSD = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' });

// ===== D√ìLAR =====
async function cargarDolar(){
  try{
    const d = await (await fetch('/api/dolar', {cache:'no-store'})).json();
    const wanted = ["OFICIAL","BLUE","BOLSA","CONTADO CON LIQUIDACI√ìN","MAYORISTA","CRIPTO","TARJETA"];
    const rows = d.filter(x=> wanted.includes(x.nombre)).sort((a,b)=> wanted.indexOf(a.nombre)-wanted.indexOf(b.nombre));
    $('#cards-dolar').innerHTML = rows.map(row=>{
      return `<div class="chip"><b>${row.nombre}</b>
                <div class="mut">venta<br><b style="color:#fff">${fmtARS.format(row.venta||0)}</b></div>
                <div class="mut">compra<br><b style="color:#fff">${fmtARS.format(row.compra||0)}</b></div>
              </div>`;
    }).join('') || '<div class="mut">Sin datos</div>';
  }catch(e){
    $('#cards-dolar').innerHTML = '<div class="mut">No se pudo cargar el d√≥lar.</div>';
  }
}

// ===== ARS por exchange (CriptoYa) =====
const ARS_ASSETS = ["USDT","USDC","DAI","BTC","ETH","SOL"];
async function cargarARS(){
  $('#pares-status').textContent = 'API: cargando‚Ä¶';
  const wrap = $('#arsTables'); wrap.innerHTML = '';
  try{
    for (const asset of ARS_ASSETS){
      const r = await fetch(`/api/ars?asset=${asset}`, {cache:'no-store'});
      const { rows } = await r.json();
      const count = rows.length;
      const table = document.createElement('div');
      table.className = 'tcard';
      table.innerHTML = `
        <div class="tcap"><h3 style="margin:0">${asset}/ARS</h3><div class="mut">${count} exchanges</div></div>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>Exchange</th><th>Par</th><th class="right">Compra</th><th class="right">Venta</th></tr></thead>
            <tbody>
              ${rows.map(r=>`
                <tr>
                  <td class="xcell">
                    <img class="logo" src="img/exchanges/${r.exchange.toLowerCase()}.png" onerror="this.style.display='none'">
                    <b style="color:#9ecbff">${r.exchange}</b>
                  </td>
                  <td>${r.pair}</td>
                  <td class="right">${r.buy_ars?fmtARS.format(r.buy_ars):'‚Äî'}</td>
                  <td class="right">${r.sell_ars?fmtARS.format(r.sell_ars):'‚Äî'}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>`;
      wrap.appendChild(table);
    }
    $('#pares-status').textContent = 'API: ok';
  }catch(e){
    console.error(e);
    $('#pares-status').textContent = 'API: error';
  }
}

// ===== /USDT por exchange (USD + ARS) =====
async function cargarPreciosUSDT(symbol='BTCUSDT'){
  try{
    $('#usdt-status').textContent = 'API: cargando‚Ä¶';
    const r = await fetch(`/api/precios?symbol=${symbol}`, {cache:'no-store'});
    const { rows, usdars } = await r.json();
    $('#usdarsRef').textContent = usdars ? fmt(usdars,2) : '‚Äî';
    const tbody = document.querySelector('#usdtTable tbody');
    tbody.innerHTML = (rows||[]).map(row=>{
      const ars = row.bid_ars != null ? fmtARS.format(row.bid_ars) : '‚Äî';
      const usd = row.bid_usd != null ? fmtUSD.format(row.bid_usd) : '‚Äî';
      return `<tr>
        <td class="xcell">
          <img class="logo" src="img/exchanges/${row.exchange.toLowerCase()}.png" onerror="this.style.display='none'">
          <b style="color:#9ecbff">${row.exchange}</b>
        </td>
        <td>${row.pair}</td>
        <td class="right">${ars}</td>
        <td class="right">${usd}</td>
      </tr>`;
    }).join('') || '<tr><td class="mut" colspan="4">Sin datos</td></tr>';
    $('#usdt-status').textContent = 'API: ok';
  }catch(e){
    console.error(e);
    $('#usdt-status').textContent = 'API: error';
  }
}

// ===== GR√ÅFICO (Binance con mirrors) =====
let chart, series, priceLine;
function initChart(){
  const el = document.getElementById('chartContainer');
  chart = LightweightCharts.createChart(el,{
    layout:{background:{color:'#0f1115'},textColor:'#DDD'},
    grid:{vertLines:{color:'#222'},horzLines:{color:'#222'}},
    timeScale:{borderColor:'#444'},
    rightPriceScale:{borderColor:'#444'},
    crosshair:{mode: LightweightCharts.CrosshairMode.Normal},
    handleScale:{ axisPressedMouseMove:true, pinch:true },
    handleScroll:{ mouseWheel:true, pressedMouseMove:true, horzTouchDrag:true }
  });
  series = chart.addCandlestickSeries({
    upColor:'#22c55e', downColor:'#ef4444',
    wickUpColor:'#22c55e', wickDownColor:'#ef4444',
    borderVisible:false, priceLineVisible:true
  });
  const ro = new ResizeObserver(()=> chart.resize(el.clientWidth, el.clientHeight));
  ro.observe(el);
  el.addEventListener('dblclick',()=> chart.timeScale().fitContent());
}
async function loadChart(symbol='BTCUSDT', interval='1h'){
  if(!chart) initChart();
  const el = document.getElementById('chartContainer');
  el.innerHTML = '';
  try{
    const r = await fetch(`/api/candles?symbol=${symbol}&interval=${interval}&limit=500`, {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const rows = await r.json();
    const data = rows.map(c=>({time:c.t/1000, open:+c.o, high:+c.h, low:+c.l, close:+c.c}));
    if(!data.length) throw new Error('sin datos');
    series.setData(data);
    chart.timeScale().fitContent();
    const last = data.at(-1);
    if(priceLine) series.removePriceLine(priceLine);
    priceLine = series.createPriceLine({ price:last?.close ?? 0, color:'#2dd4bf', lineWidth:2, axisLabelVisible:true, title:'√öltimo' });
  }catch(e){
    console.error(e);
    el.innerHTML = '<div style="color:#f66;padding:10px">No se pudo cargar el gr√°fico.</div>';
  }
}
document.getElementById('btnLoad').addEventListener('click',()=>{
  const s = document.getElementById('sym').value;
  const tf = document.getElementById('tf').value;
  loadChart(s, tf);
});

// ===== TA =====
document.getElementById('btnTA').addEventListener('click', async ()=>{
  const s = document.getElementById('sym').value;
  const tf = document.getElementById('tf').value;
  $('#taBox').textContent = 'Analizando‚Ä¶';
  try{
    const r = await fetch(`/api/ta?symbol=${s}&interval=${tf}`, {cache:'no-store'});
    const j = await r.json();
    if (!r.ok) throw new Error(j?.message || 'error');
    $('#taBox').textContent = j.summary || 'Sin resumen';
  }catch(e){
    $('#taBox').textContent = 'No se pudo generar el an√°lisis.';
  }
});

// ===== INICIO =====
(async function init(){
  cargarDolar();
  cargarARS();
  cargarPreciosUSDT('BTCUSDT');
  loadChart('BTCUSDT','1h'); // autocarga
  // refresco precios USDT cada 30s
  setInterval(()=> cargarPreciosUSDT(document.getElementById('sym')?.value || 'BTCUSDT'), 30000);
})();
</script>
</body>
</html>
