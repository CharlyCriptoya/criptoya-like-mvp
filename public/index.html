<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charly Cripto ‚Ä¢ MVP</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{--bg:#0e0f13;--card:#151821;--mut:#9aa3b2;--line:#232833;--txt:#e8ecf1}
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--txt);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
    background:
      linear-gradient(0deg, rgba(0,0,0,.55), rgba(0,0,0,.55)),
      url('Muro.jpg') center / cover fixed no-repeat;
  }
  a{color:#9ecbff}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0 0 10px;font-size:22px}
  .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
  .mut{color:var(--mut)}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#0f1218;border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-width:160px}
  .chip b{display:block}
  .pair-grid{display:grid;gap:12px}
  @media(min-width:900px){.pair-grid{grid-template-columns:1fr 1fr}}
  .pair-card{background:#0f1218;border:1px solid var(--line);border-radius:12px;padding:12px}
  .pair-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .xcell{display:flex;align-items:center;gap:8px}
  .xcell img.logo{width:18px;height:18px;object-fit:contain;border-radius:4px;flex:0 0 18px}
  .priceStack{display:flex;flex-direction:column;align-items:end;line-height:1.15}
  .priceUSD{color:#9aa3b2;font-size:12px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 10px}
  select,button,textarea,input{background:#0f1218;color:var(--txt);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:14px}
  button{cursor:pointer}
  #chartWrap{height:360px;background:#0f1115;border-radius:12px;position:relative}
  #chartContainer{width:100%;height:100%}
  #ta{white-space:pre-wrap}
</style>
</head>
<body>
  <main class="wrap">
    <div style="display:flex;align-items:center;gap:10px">
      <img src="logo.png" alt="Logo" style="height:40px;border-radius:8px" onerror="this.style.display='none'">
      <h1 style="margin:0">Charly Cripto ‚Ä¢ MVP</h1>
    </div>
    <div class="mut">D√≥lar por <a href="https://dolarapi.com" target="_blank">dolarapi</a> ‚Ä¢ Cripto por Binance y <a href="https://criptoya.com" target="_blank">CriptoYa</a> (v√≠a backend).</div>

    <!-- D√ìLAR -->
    <section class="section">
      <div id="cards-dolar" class="chips">Cargando d√≥lar‚Ä¶</div>
    </section>

    <!-- /USDT -->
    <section class="section">
      <h2 style="margin:0 0 8px">Pares /USDT por exchange</h2>
      <div class="mut" id="usdt-status">API: comprobando‚Ä¶</div>
      <div class="pair-grid" id="usdtPairs"></div>
    </section>

    <!-- GR√ÅFICO -->
    <section class="section">
      <h2 style="margin:0 0 8px">üìâ Gr√°fico (Binance) + An√°lisis t√©cnico</h2>
      <div class="controls">
        <select id="sym">
          <option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option>
          <option>BNBUSDT</option><option>ADAUSDT</option><option>XRPUSDT</option>
          <option>DOGEUSDT</option><option>MATICUSDT</option><option>LINKUSDT</option>
          <option>TONUSDT</option>
        </select>
        <select id="tf">
          <option value="1m">1m</option><option value="5m">5m</option>
          <option value="15m">15m</option><option value="30m">30m</option>
          <option value="1h" selected>1h</option><option value="4h">4h</option>
          <option value="1d">1d</option>
        </select>
        <button id="btnLoad">Cargar gr√°fico</button>
        <button id="btnTA">An√°lisis t√©cnico</button>
      </div>
      <div id="chartWrap"><div id="chartContainer"></div></div>
      <div class="mut" style="margin-top:6px">Doble clic para ajustar vista.</div>
      <div id="ta" class="mut" style="margin-top:10px"></div>
    </section>
  </main>

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<script>
const $ = s => document.querySelector(s);
const fmt = (n,d=2)=> Number(n).toLocaleString('es-AR',{maximumFractionDigits:d});
const fmtARS = new Intl.NumberFormat('es-AR', { style:'currency', currency:'ARS', maximumFractionDigits:0 });
const fmtUSD = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD' });

/* ========== D√ìLAR ========== */
async function cargarDolar(){
  try{
    const res = await fetch('/api/dolar',{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const d = await res.json();
    $('#cards-dolar').innerHTML = (d||[]).map(row=>{
      const nombre = (row.casa || row.nombre || 'D√ìLAR').toUpperCase();
      return `<div class="chip"><b>${nombre}</b>
        <div class="mut">venta <b style="color:#fff">${fmtARS.format(row.venta||0)}</b></div>
        <div class="mut">compra <b style="color:#fff">${fmtARS.format(row.compra||0)}</b></div>
      </div>`;
    }).join('') || '<div class="mut">Sin datos</div>';
  }catch(e){
    $('#cards-dolar').innerHTML = '<div class="mut">No se pudo cargar el d√≥lar.</div>';
  }
}

/* ========== /USDT: ARS + USD (lista completa, sin filtros) ========== */
async function cargarPreciosUSDT(symbol='BTCUSDT'){
  try{
    $('#usdt-status').textContent = 'API: cargando‚Ä¶';
    const r = await fetch(`/api/precios?symbol=${encodeURIComponent(symbol)}`, {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const payload = await r.json();
    const rows = payload.rows || payload || [];
    const usdars = payload.usdars;

    // ordenar por mejor precio ARS si existe
    rows.sort((a,b)=>(b.bid_ars??0)-(a.bid_ars??0));

    const html = rows.map(row=>{
      if(row?.error) return '';
      const ex = (row.exchange||'').toUpperCase();
      const pair = row.pair || symbol;
      const ars = row.bid_ars!=null ? fmtARS.format(row.bid_ars) : '‚Äî';
      const usd = row.bid_usd!=null ? fmtUSD.format(row.bid_usd) : '‚Äî';
      const logo = `/img/${ex.toLowerCase()}.png`;
      return `<div class="pair-card">
        <div class="pair-title">
          <div class="xcell">
            <img class="logo" src="${logo}" onerror="this.style.display='none'">
            <span style="color:#9ecbff;font-weight:700">${ex||'‚Äî'}</span>
          </div>
          <div class="priceStack">
            <span>${ars}</span>
            <span class="priceUSD">${usd} / USDT</span>
          </div>
        </div>
        <div class="mut">${pair}</div>
      </div>`;
    }).join('');

    $('#usdtPairs').innerHTML = html || '<div class="mut">Sin datos</div>';
    $('#usdt-status').textContent = `USDARS ref: ${usdars ? fmt(usdars,2) : '‚Äî'}`;
  }catch(e){
    console.error(e);
    $('#usdt-status').textContent = 'API: error';
    $('#usdtPairs').innerHTML = '<div class="mut">No se pudieron cargar los precios.</div>';
  }
}

/* ========== GR√ÅFICO (Binance) ========== */
let chart, series, lastData=[];
function initChart(){
  const el = $('#chartContainer');
  chart = LightweightCharts.createChart(el,{
    layout:{background:{color:'#0f1115'},textColor:'#DDD'},
    grid:{vertLines:{color:'#222'},horzLines:{color:'#222'}},
    timeScale:{borderColor:'#444'},
    rightPriceScale:{borderColor:'#444'},
    crosshair:{mode:LightweightCharts.CrosshairMode.Normal},
    handleScale:{axisPressedMouseMove:true,pinch:true},
    handleScroll:{mouseWheel:true,pressedMouseMove:true,horzTouchDrag:true}
  });
  series = chart.addCandlestickSeries({
    upColor:'#22c55e', downColor:'#ef4444',
    wickUpColor:'#22c55e', wickDownColor:'#ef4444',
    borderVisible:false
  });
  new ResizeObserver(()=> chart.resize(el.clientWidth, el.clientHeight)).observe(el);
  el.addEventListener('dblclick',()=> chart.timeScale().fitContent());
}

async function loadChart(symbol='BTCUSDT', interval='1h'){
  if(!chart) initChart();
  try{
    const url = `/api/candles?symbol=${encodeURIComponent(symbol)}&interval=${interval}&limit=500`;
    const r = await fetch(url,{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const raw = await r.json();

    // admitir dos formatos: [{t,o,h,l,c}] o arrays [t,o,h,l,c]
    const data = (raw.rows||raw||[]).map(c=>{
      if(Array.isArray(c)) return {time:Math.floor(c[0]/1000), open:+c[1], high:+c[2], low:+c[3], close:+c[4]};
      return {time:Math.floor(c.t/1000), open:+c.o, high:+c.h, low:+c.l, close:+c.c};
    });

    if(!data.length) throw new Error('sin datos');
    lastData = data;
    series.setData(data);
    chart.timeScale().fitContent();
  }catch(e){
    console.error(e);
    $('#chartContainer').innerHTML = `<div style="color:#f66;padding:10px">No se pudo cargar el gr√°fico (${e.message}).</div>`;
  }
}

/* ========== An√°lisis t√©cnico local + (opcional) backend GPT ========== */
function ema(values, p){
  const k = 2/(p+1);
  let ema=[], prev=values[0];
  ema.push(prev);
  for(let i=1;i<values.length;i++){ prev = values[i]*k + prev*(1-k); ema.push(prev); }
  return ema;
}
function rsi(closes, p=14){
  let gains=0, losses=0;
  for(let i=1;i<=p;i++){
    const ch = closes[i]-closes[i-1];
    if(ch>=0) gains+=ch; else losses-=ch;
  }
  let rs = (gains/p)/((losses/p)||1e-9), out=[...Array(p).fill(null), 100-100/(1+rs)];
  for(let i=p+1;i<closes.length;i++){
    const ch = closes[i]-closes[i-1];
    const g = Math.max(ch,0), l = Math.max(-ch,0);
    gains = (gains*(p-1) + g)/p; losses = (losses*(p-1) + l)/p;
    rs = (gains)/((losses)||1e-9);
    out.push(100-100/(1+rs));
  }
  return out;
}
function macd(closes, f=12, s=26, sig=9){
  const emaF = ema(closes,f), emaS = ema(closes,s);
  const mac = emaF.map((v,i)=> v - emaS[i]);
  const sigl = ema(mac.slice(s-1), sig);
  const hist = mac.slice(s-1).map((v,i)=> v - sigl[i]);
  return {mac:mac.slice(s-1), sig:sigl, hist};
}

async function hacerTA(){
  if(!lastData.length){ $('#ta').textContent='Carg√° el gr√°fico primero.'; return; }
  const closes = lastData.map(d=>d.close);
  const r = rsi(closes,14).at(-1);
  const ema20 = ema(closes,20).at(-1);
  const ema50 = ema(closes,50).at(-1);
  const {mac, sig, hist} = macd(closes);
  const macdVal = mac.at(-1), sigVal = sig.at(-1), histVal = hist.at(-1);
  const last = lastData.at(-1).close;

  let txt = `√öltimo: ${fmt(last)}\nRSI(14): ${fmt(r,2)} ‚Äî ${r>70?'sobrecompra':r<30?'sobreventa':'neutral'}\n`+
            `EMA20: ${fmt(ema20)} | EMA50: ${fmt(ema50)} ‚Äî ${ema20>ema50?'sesgo alcista':'sesgo bajista'}\n`+
            `MACD: ${fmt(macdVal,4)} vs Se√±al ${fmt(sigVal,4)} (hist ${fmt(histVal,4)}) ‚Äî `+
            `${macdVal>sigVal?'momentum ‚Üë':'momentum ‚Üì'}`;

  $('#ta').textContent = txt;

  // Si luego agreg√°s un endpoint GPT en tu server, descoment√° esto:
  // try{
  //   const s = $('#sym').value, tf = $('#tf').value;
  //   const res = await fetch('/api/ta', {method:'POST',headers:{'Content-Type':'application/json'},
  //     body: JSON.stringify({symbol:s, interval:tf, summary:txt})});
  //   if(res.ok){ const j = await res.json(); $('#ta').textContent = j.text||txt; }
  // }catch{}
}

/* ========== Eventos & arranque ========== */
$('#btnLoad').addEventListener('click',()=>{
  const s = $('#sym').value; const tf = $('#tf').value; loadChart(s, tf);
});
$('#btnTA').addEventListener('click', hacerTA);

(async function init(){
  cargarDolar();
  cargarPreciosUSDT('BTCUSDT');
  loadChart('BTCUSDT','1h');           // auto
  setInterval(()=> cargarPreciosUSDT($('#sym')?.value || 'BTCUSDT'), 30000);
})();
</script>
</body>
</html>
