<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="theme-color" content="#0b0f16"/>
  <title>Arbolito â€” GrÃ¡fico (Binance)</title>
  <style>
    :root{
      --text:#e5e7eb;--muted:#a1a1aa;--line:rgba(255,255,255,.08);--cardBg:rgba(10,13,20,.84);
      --chipBg:rgba(255,255,255,.06);--ok:#22c55e;--bad:#ef4444;--accent:#60a5fa
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      background:#0b0f16 url('Muro.jpg') center/cover fixed no-repeat;
      overflow-x:hidden
    }
    .page{max-width:560px;margin:0 auto;padding:14px}
    h1{margin:6px 0 10px;font-size:18px;letter-spacing:.2px}
    .card{background:var(--cardBg);border:1px solid var(--line);border-radius:14px;padding:10px}
    a{color:var(--accent);text-decoration:none}

    /* â€”â€” Widget grÃ¡fico â€”â€” */
    .ai-grid{display:grid;gap:10px}
    .ai-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .ai-toolbar input,.ai-toolbar select{
      background:rgba(255,255,255,.08);border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px
    }
    .btn{padding:9px 12px;border:1px solid var(--line);background:var(--chipBg);color:var(--text);border-radius:10px;cursor:pointer}
    .btn.primary{background:#fff;color:#111;border-color:#e5e7eb;font-weight:700}
    #chart{height:360px}
    .note{font-size:11px;color:var(--muted);margin-top:6px}
    .badge{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid var(--line);background:var(--chipBg);margin-left:6px}

    /* â€”â€” Stats & Rangos â€”â€” */
    .stats24h{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0;font-size:12px}
    .stat-box{flex:1;min-width:120px;background:var(--cardBg);border:1px solid var(--line);border-radius:10px;padding:8px}
    .ranges{display:flex;gap:6px;margin-top:6px}
    .range-btn{flex:1;padding:6px 8px;border:1px solid var(--line);border-radius:6px;background:var(--chipBg);cursor:pointer;font-size:12px}
    .range-btn.active{background:#fff;color:#111;font-weight:700}
  </style>
</head>
<body>
  <div class="page">
    <h1 style="margin:0 0 6px">ðŸ“ˆ GrÃ¡fico (Binance) & Stats 24 h</h1>
    <div class="card">
      <div class="ai-grid">
        <div>
          <div class="ai-toolbar">
            <select id="wgExchange" aria-label="Exchange">
              <option value="binance" selected>Binance</option>
            </select>
            <input id="wgBase" value="BTC" placeholder="BTC, ETH, SOLâ€¦" size="8" aria-label="Base"/>
            <select id="wgQuote" aria-label="CotizaciÃ³n">
              <option value="USDT" selected>USDT</option>
            </select>
            <select id="wgTF" aria-label="Timeframe">
              <option value="1m" selected>1m</option>
              <option value="5m">5m</option>
              <option value="15m">15m</option>
              <option value="1h">1h</option>
              <option value="4h">4h</option>
              <option value="1d">1d</option>
            </select>
            <button class="btn primary" id="btnLoad">Cargar grÃ¡fico</button>
            <button class="btn" id="btnDownload">Descargar PNG</button>
          </div>

          <!-- ðŸ“Š Stats 24h -->
          <div id="stats24h" class="stats24h"></div>

          <!-- â± Rangos -->
          <div class="ranges" role="group" aria-label="Rangos rÃ¡pidos">
            <button class="range-btn active" data-range="1m">1m</button>
            <button class="range-btn" data-range="5m">5m</button>
            <button class="range-btn" data-range="15m">15m</button>
            <button class="range-btn" data-range="1h">1h</button>
            <button class="range-btn" data-range="4h">4h</button>
            <button class="range-btn" data-range="1d">1d</button>
          </div>

          <div id="chart" aria-label="GrÃ¡fico de velas"></div>
          <div class="note">El grÃ¡fico usa **kline** de Binance. Las stats calculan Ãšltimo, MÃ¡x, MÃ­n y %Cambio sobre las velas cargadas.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- LibrerÃ­a de grÃ¡ficos -->
  <script src="https://unpkg.com/lightweight-charts@4.2.3/dist/lightweight-charts.standalone.production.js"></script>

  <script>
  /* ===== Utilidades ===== */
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const nfUS = new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:8});

  /* ===== Stats 24h ===== */
  function updateStats24h(data){
    if(!data?.length) return;
    const closes=data.map(d=>+d.c);
    const highs=data.map(d=>+d.h);
    const lows =data.map(d=>+d.l);
    const last = closes[closes.length-1];
    const max  = Math.max(...highs);
    const min  = Math.min(...lows);
    const chg  = ((last - closes[0]) / closes[0]) * 100;
    $('#stats24h').innerHTML = `
      <div class="stat-box"><strong>Ãšltimo</strong><br>${nfUS.format(last)}</div>
      <div class="stat-box"><strong>MÃ¡x 24h</strong><br>${nfUS.format(max)}</div>
      <div class="stat-box"><strong>MÃ­n 24h</strong><br>${nfUS.format(min)}</div>
      <div class="stat-box"><strong>Cambio</strong><br>${chg.toFixed(2)}%</div>`;
  }

  /* ===== GrÃ¡fico (Binance) ===== */
  let chart, candleSeries, lastCandles=[];
  const chartEl = $('#chart');

  function initChart(){
    chart?.remove();
    chart = LightweightCharts.createChart(chartEl,{
      width: chartEl.clientWidth, height: 360,
      layout:{background:{type:'solid',color:'transparent'},textColor:'#e5e7eb'},
      grid:{vertLines:{color:'rgba(255,255,255,0.06)'},horzLines:{color:'rgba(255,255,255,0.06)'}},
      rightPriceScale:{borderVisible:false}, timeScale:{borderVisible:false}
    });
    candleSeries = chart.addCandlestickSeries();
    new ResizeObserver(()=> chart.applyOptions({width: chartEl.clientWidth}) ).observe(chartEl);
  }

  const TF_MAP = { '1m':'1m','5m':'5m','15m':'15m','1h':'1h','4h':'4h','1d':'1d' };

  function toSeries(data){ // [{t,o,h,l,c}] -> LWC
    return data.map(d=>({time: Math.floor(d.t/1000), open:+d.o, high:+d.h, low:+d.l, close:+d.c}));
  }

  async function fetchKlinesBinance(base, quote, tf){
    const url = `https://api.binance.com/api/v3/klines?symbol=${base.toUpperCase()}${quote.toUpperCase()}&interval=${TF_MAP[tf]||'1m'}&limit=300`;
    const r = await fetch(url);
    const arr = await r.json();
    // kline: [ openTime, open, high, low, close, ... ]
    return Array.isArray(arr) ? arr.map(k=>({t:+k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4]})) : [];
  }

  async function loadChartFromUI(){
    const base = ($('#wgBase').value || 'BTC').trim();
    const quote = $('#wgQuote').value || 'USDT';
    const tf = $('#wgTF').value || '1m';

    $('#btnLoad').disabled = true;
    try{
      const data = await fetchKlinesBinance(base, quote, tf);
      lastCandles = data;
      initChart();
      candleSeries.setData(toSeries(data));
      updateStats24h(data);
    }catch(e){
      console.error('loadChart error', e);
      alert('No se pudo cargar el grÃ¡fico. ProbÃ¡ nuevamente.');
    }finally{
      $('#btnLoad').disabled = false;
    }
  }

  function downloadPNG(){
    const cv = chartEl.querySelector('canvas');
    if(!cv){ alert('No hay canvas para descargar'); return; }
    const link=document.createElement('a');
    link.download=`chart_${Date.now()}.png`;
    link.href=cv.toDataURL('image/png');
    link.click();
  }

  function attachEvents(){
    $('#btnLoad').onclick = loadChartFromUI;
    $('#btnDownload').onclick = downloadPNG;

    $$('.range-btn').forEach(btn=>{
      btn.onclick = ()=>{
        $$('.range-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        $('#wgTF').value = btn.dataset.range;
        loadChartFromUI();
      };
    });
  }

  // ==== INIT (auto-carga BTC/USDT 1m) ====
  (async function(){
    attachEvents();
    // Defaults
    $('#wgBase').value = 'BTC';
    $('#wgQuote').value = 'USDT';
    $('#wgTF').value = '1m';
    await loadChartFromUI();
  })();
  </script>

  <!-- build marker -->
  <div style="position:fixed;bottom:8px;right:10px;font:12px system-ui;color:#9ca3af;">build v2.1 (binance-only)</div>
</body>
</html>
