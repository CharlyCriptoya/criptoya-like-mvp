<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Binance • Precio en vivo + Alertas</title>
  <style>
    :root{--bg:#0f1222;--card:#171a2e;--text:#e8ecf1;--muted:#9aa3b2;--ok:#2ecc71;--down:#e74c3c;--accent:#5b8cff;}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#0d1020,#0b0e1b 30%,#0f1222);}
    header{padding:18px 20px;border-bottom:1px solid #232642;background:#0f1222;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:18px;color:var(--text);letter-spacing:.4px}
    main{max-width:900px;margin:18px auto;padding:0 16px 40px}
    .controls{display:flex;flex-wrap:wrap;gap:12px;margin-top:10px}
    .control{background:var(--card);border:1px solid #232642;color:var(--text);padding:10px 12px;border-radius:10px;display:flex;align-items:center;gap:8px}
    select,input[type="number"],input[type="text"]{background:#0c1022;border:1px solid #2a2e4a;color:var(--text);padding:8px 10px;border-radius:8px;min-width:120px}
    input[type="checkbox"]{transform:scale(1.1)}
    button{background:var(--accent);border:none;color:white;padding:10px 14px;border-radius:8px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .board{display:grid;grid-template-columns:1fr;gap:14px;margin-top:16px}
    @media(min-width:700px){.board{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid #232642;border-radius:14px;padding:16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .pair{font-weight:700;color:var(--text)}
    .muted{font-size:12px;color:var(--muted)}
    .price{font-size:40px;font-weight:900;color:var(--text);line-height:1.1}
    .sub{display:flex;gap:12px;margin-top:8px}
    .chip{font-size:12px;color:var(--muted);border:1px solid #2a2e4a;padding:4px 8px;border-radius:999px}
    .blink-up{animation:blinkUp .6s ease}
    .blink-down{animation:blinkDown .6s ease}
    @keyframes blinkUp{0%{background:rgba(46,204,113,.18)}100%{background:transparent}}
    @keyframes blinkDown{0%{background:rgba(231,76,60,.18)}100%{background:transparent}}
    .foot{color:#97a0b5;text-align:center;font-size:12px;margin-top:14px}
  </style>
</head>
<body>
<header>
  <h1>Binance • Precio en tiempo real + alertas</h1>
  <div class="controls">
    <div class="control">
      <label>Par</label>
      <select id="symbol">
        <option value="BTCUSDT" selected>BTC/USDT</option>
        <option value="ETHUSDT">ETH/USDT</option>
        <option value="BNBUSDT">BNB/USDT</option>
        <option value="SOLUSDT">SOL/USDT</option>
        <option value="ADAUSDT">ADA/USDT</option>
        <option value="DOGEUSDT">DOGE/USDT</option>
      </select>
    </div>
    <div class="control">
      <label>o escribí otro</label>
      <input id="custom" type="text" placeholder="Ej: XRPUSDT" />
      <button id="useCustom">Usar</button>
    </div>
    <div class="control">
      <label>Alerta ↑</label>
      <input id="alertHigh" type="number" step="0.01" placeholder="> precio" />
    </div>
    <div class="control">
      <label>Alerta ↓</label>
      <input id="alertLow" type="number" step="0.01" placeholder="< precio" />
    </div>
    <div class="control">
      <label>Sonido</label>
      <input id="sound" type="checkbox" checked />
    </div>
    <div class="control">
      <button id="apply">Aplicar</button>
    </div>
  </div>
</header>

<main>
  <section class="board">
    <div class="card" id="tickerCard">
      <div class="row">
        <div>
          <div class="pair" id="pairLbl">BTC/USDT (Binance)</div>
          <div class="muted" id="status">Conectando…</div>
        </div>
        <div class="price" id="price">—</div>
      </div>
      <div class="sub">
        <div class="chip" id="lastTime">—</div>
        <div class="chip" id="lastSide">—</div>
      </div>
    </div>

    <div class="card">
      <div class="row"><div class="pair">Alertas</div></div>
      <div class="sub" style="margin-top:10px">
        <div class="chip">↑ Alerta superior: <span id="ah">—</span></div>
        <div class="chip">↓ Alerta inferior: <span id="al">—</span></div>
        <div class="chip">Sonido: <span id="snd">On</span></div>
      </div>
      <div class="foot">Permite notificaciones del navegador para avisos incluso si cambiás de pestaña.</div>
    </div>
  </section>

  <div class="foot">Fuente: WebSocket oficial de Binance (trade stream). Reconecta solo si se corta.</div>
</main>

<script>
  /************ Utils ************/
  const $ = (id) => document.getElementById(id);
  const fmt = (n) => {
    if (n == null || isNaN(n)) return '—';
    const a = Math.abs(n);
    const dp = a >= 100000 ? 0 : a >= 1000 ? 2 : 4;
    return Number(n).toLocaleString(undefined,{minimumFractionDigits:dp,maximumFractionDigits:dp});
  };
  const tStr = (t) => new Date(t).toLocaleTimeString();

  // Beep simple
  const beep = () => {
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type='sine'; o.frequency.value = 880;
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.2);
      o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.21);
    }catch{}
  };

  // Noti
  const notify = (title, body) => {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'granted') new Notification(title,{body});
    else if (Notification.permission !== 'denied') {
      Notification.requestPermission().then(p=>{ if(p==='granted') new Notification(title,{body}); });
    }
  };

  /************ Estado ************/
  const state = {
    symbol: 'BTCUSDT',
    ws: null,
    lastPrice: null,
    alertHigh: null,
    alertLow: null,
    sound: true,
    lastAlertSide: null
  };

  // UI refs
  const symbolSel = $('symbol');
  const customInp = $('custom');
  const useCustom = $('useCustom');
  const applyBtn  = $('apply');
  const soundInp  = $('sound');
  const ahLbl = $('ah'), alLbl = $('al'), sndLbl = $('snd');
  const priceEl = $('price'), statusEl = $('status'), pairLbl = $('pairLbl'), lastTime = $('lastTime'), lastSide = $('lastSide');
  const tickerCard = $('tickerCard');

  /************ Conexión Binance ************/
  const streamURL = (sym) => `wss://stream.binance.com:9443/ws/${sym.toLowerCase()}@trade`;

  function connect(sym){
    cleanup();
    state.symbol = sym.toUpperCase();
    pairLbl.textContent = `${sym.toUpperCase().replace('USDT','')}/USDT (Binance)`;
    statusEl.textContent = 'Conectando…';
    priceEl.textContent = '—';
    lastSide.textContent = '—';
    lastTime.textContent = '—';

    let retries = 0;
    const openWS = () => {
      const ws = new WebSocket(streamURL(state.symbol));
      state.ws = ws;

      ws.onopen = () => {
        retries = 0;
        statusEl.textContent = 'Conectado';
      };

      ws.onmessage = (ev) => {
        try{
          const d = JSON.parse(ev.data);
          // Campos de trade: p (precio), m (isMarketMaker / side), T (trade time)
          const p = parseFloat(d.p);
          if (!isNaN(p)) {
            const prev = state.lastPrice;
            state.lastPrice = p;
            priceEl.textContent = fmt(p);
            lastTime.textContent = tStr(d.T || Date.now());
            const side = d.m ? '↓ (agresor vendedor)' : '↑ (agresor comprador)';
            lastSide.textContent = side;

            // efecto de parpadeo según dirección
            if (prev != null) {
              const cls = p > prev ? 'blink-up' : p < prev ? 'blink-down' : '';
              if (cls) {
                tickerCard.classList.remove('blink-up','blink-down');
                // forzar reflow
                void tickerCard.offsetWidth;
                tickerCard.classList.add(cls);
              }
            }

            checkAlerts(p);
          }
        }catch(e){}
      };

      ws.onclose = () => {
        statusEl.textContent = 'Desconectado, reintentando…';
        const delay = Math.min(1000*Math.pow(2,retries++), 15000);
        setTimeout(openWS, delay);
      };

      ws.onerror = () => {
        try{ ws.close(); }catch{}
      };
    };
    openWS();
  }

  function cleanup(){
    if (state.ws) {
      try{ state.ws.onopen = state.ws.onmessage = state.ws.onclose = state.ws.onerror = null; state.ws.close(); }catch{}
      state.ws = null;
    }
  }

  /************ Alertas ************/
  function checkAlerts(price){
    if (state.alertHigh != null && price >= state.alertHigh && state.lastAlertSide !== 'high') {
      triggerAlert(`Superó ${fmt(state.alertHigh)}`, `Precio ${state.symbol}: ${fmt(price)}`, 'high');
    }
    if (state.alertLow != null && price <= state.alertLow && state.lastAlertSide !== 'low') {
      triggerAlert(`Cayó por debajo de ${fmt(state.alertLow)}`, `Precio ${state.symbol}: ${fmt(price)}`, 'low');
    }
    // reset cuando vuelve al rango para permitir nuevo disparo
    if (state.alertHigh != null && price < state.alertHigh && state.lastAlertSide === 'high') state.lastAlertSide = null;
    if (state.alertLow != null && price > state.alertLow && state.lastAlertSide === 'low') state.lastAlertSide = null;
  }

  function triggerAlert(title, body, side){
    if (state.sound) beep();
    notify(title, body);
    state.lastAlertSide = side;
  }

  /************ Eventos UI ************/
  applyBtn.addEventListener('click', () => {
    const high = parseFloat($('alertHigh').value);
    const low  = parseFloat($('alertLow').value);
    state.alertHigh = isNaN(high) ? null : high;
    state.alertLow  = isNaN(low)  ? null : low;
    ahLbl.textContent = state.alertHigh != null ? fmt(state.alertHigh) : '—';
    alLbl.textContent = state.alertLow  != null ? fmt(state.alertLow)  : '—';
    state.sound = soundInp.checked;
    sndLbl.textContent = state.sound ? 'On' : 'Off';
  });

  soundInp.addEventListener('change', () => {
    state.sound = soundInp.checked;
    sndLbl.textContent = state.sound ? 'On' : 'Off';
  });

  symbolSel.addEventListener('change', () => connect(symbolSel.value));
  useCustom.addEventListener('click', () => {
    const s = customInp.value.trim().toUpperCase();
    if (!s) return;
    symbolSel.value = s; // aunque no esté en la lista, lo seteamos visualmente
    connect(s);
  });

  // Arranque
  connect(state.symbol);

  // Pedimos permiso de notificaciones temprano (opcional)
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().catch(()=>{});
  }

  // Limpieza al salir
  window.addEventListener('beforeunload', cleanup);
</script>
</body>
</html>
