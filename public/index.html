<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CriptoYA-like</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 1rem;
    }
    h2 { margin-top: 0; }
    ul.quotes { list-style: none; padding: 0; margin: 0; }
    .quote-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: .6rem .8rem; border-bottom: 1px solid #2a2a2a;
    }
    .quote-left { display: flex; align-items: center; gap: .6rem; }
    .exch-logo { width: 22px; height: 22px; border-radius: 6px; object-fit: cover; }
    .exch-name { font-weight: 700; }
    .quote-right { display: flex; flex-direction: column; align-items: flex-end; }
    .price { font-weight: 800; }
    .sub { opacity: .7; font-size: .9em; }
    /* Colores especiales */
    .best-buy { color: #00c853; }  /* verde */
    .best-sell { color: #d50000; } /* rojo */

    /* ======== ESTILOS AISLADOS DEL WIDGET ======== */
    .aw-card{background:#151923;border:1px solid #232a39;border-radius:14px;padding:14px;margin-top:18px}
    .aw-title{margin:0 0 10px;font-weight:800;color:#e8eefc;letter-spacing:.3px}
    .aw-row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .aw-chip,.aw-btn{padding:8px 12px;border-radius:999px;border:1px solid #2b3346;background:#1a2030;color:#dde6ff;cursor:pointer}
    .aw-chip.aw-active,.aw-btn.primary{background:#4ec3ff;color:#081018;border-color:transparent}
    #aw-tv{height:420px;border:1px solid #232a39;border-radius:10px;overflow:hidden}
    .aw-grid{display:grid;gap:10px}
    @media(min-width:900px){ .aw-grid{grid-template-columns:2fr 1fr} }
    .aw-kv{display:flex;justify-content:space-between;border-bottom:1px solid #232a39;padding:6px 0}
    .aw-kv:last-child{border-bottom:none}
    .aw-green{color:#00e676}.aw-red{color:#ff1744}.aw-mut{color:#9aa4b2}
    .aw-small{font-size:.9em}
    .aw-input{flex:1;padding:8px;border-radius:10px;border:1px solid #2b3346;background:#0f141f;color:#e8eefc}
    .aw-badge{display:inline-block;padding:2px 8px;border-radius:6px;background:#21293b;color:#bcd0ff;font-size:.8em}
    .aw-pre{white-space:pre-wrap;line-height:1.35}
  </style>
</head>
<body>
  <h2>USDT/ARS</h2>
  <ul id="quotes-list" class="quotes"></ul>

  <!-- ============ WIDGET NUEVO (Gráfico + Análisis técnico) ============ -->
  <section class="aw-card" aria-label="Gráfico y análisis">
    <div class="aw-row" style="justify-content:space-between;align-items:center">
      <h3 class="aw-title">📊 Gráfico + Análisis técnico</h3>
      <span class="aw-badge">Beta</span>
    </div>

    <!-- favoritos -->
    <div id="aw-favs" class="aw-row"></div>

    <!-- timeframes -->
    <div id="aw-tfs" class="aw-row"></div>

    <!-- gráfico -->
    <div id="aw-tv"></div>

    <!-- acciones -->
    <div class="aw-row" style="margin:10px 0 6px">
      <button id="aw-show" class="aw-btn">Mostrar gráfico</button>
      <button id="aw-run"  class="aw-btn primary">Análisis técnico completo</button>
      <a id="aw-news" class="aw-btn" target="_blank" rel="noopener">Noticias</a>
    </div>

    <!-- otra moneda -->
    <div class="aw-row" style="align-items:center">
      <input id="aw-other" class="aw-input" placeholder="Otra (ej. ARBUSDT, PEPEUSDT)">
      <button id="aw-use" class="aw-btn">Analizar</button>
    </div>

    <!-- resultado -->
    <div id="aw-res" class="aw-card" style="margin:12px 0 0; padding:12px; display:none">
      <div class="aw-kv"><span>Sesgo / Tendencia</span><span id="aw-bias"></span></div>
      <div class="aw-kv"><span>Entrada sugerida</span><span id="aw-entry">$ —</span></div>
      <div class="aw-kv"><span>Stop-loss</span><span id="aw-sl" class="aw-red">$ —</span></div>
      <div class="aw-kv"><span>Take-profits (1× / 1.5× / 2× ATR)</span><span id="aw-tp" class="aw-green">$ —</span></div>
      <div class="aw-kv"><span>Mín/Máx del día</span><span id="aw-day">$ — / —</span></div>
      <div id="aw-ind" class="aw-small aw-mut" style="margin-top:6px">RSI, EMA20/50, MACD, ATR</div>
      <div id="aw-text" class="aw-small aw-pre" style="margin-top:10px"></div>
      <div class="aw-small aw-mut" style="margin-top:8px">Uso educativo. No es consejo financiero.</div>
    </div>
  </section>
  <!-- ============ /WIDGET NUEVO ============ -->

  <!-- TradingView solo para el widget -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <script>
    /* ======== LISTA ORIGINAL: agrego filtro ArgenBTC y mantengo resaltado ======== */
    const norm = s => String(s || '').toLowerCase().replace(/\s+/g,'').trim();
    const FALLBACK_LOGO = 'https://upload.wikimedia.org/wikipedia/commons/3/3f/Placeholder_view_vector.svg';
    const BLOCKLIST = new Set(['argenbtc','argen btc','argen-btc','argenbtcexchange']);
    const LOGOS = {
      ripio: "https://cryptologos.cc/logos/ripio-logo.png",
      satoshitango: "https://cryptologos.cc/logos/bitcoin-btc-logo.png",
      lemoncash: "https://seeklogo.com/images/L/lemon-cash-logo-0C3D8E1E3E-seeklogo.com.png",
      buenbit: "https://pbs.twimg.com/profile_images/1564998121880360960/LqR37f-v_400x400.jpg",
      letsbit: "https://pbs.twimg.com/profile_images/1697329473060747264/S9WnC6bE_400x400.jpg",
      fiwind: "https://play-lh.googleusercontent.com/0g8Y0uJf4YVb1rZB3T7mVdSx3QZ2Q1QfK8e3uZ0O9s2h=s180",
      binance: "https://cryptologos.cc/logos/binance-coin-bnb-logo.png"
    };

    function renderQuotes(quotes) {
      const list = document.getElementById("quotes-list");
      list.innerHTML = "";

      // Filtro de exchanges bloqueados (ej: ArgenBTC)
      quotes = quotes.filter(q => !BLOCKLIST.has(norm(q.exchange)));

      if (!quotes.length) {
        list.innerHTML = "<li>No hay cotizaciones</li>";
        return;
      }

      // calcular mejor compra y mejor venta
      const bestBuy = Math.min(...quotes.map(q => q.buy));
      const bestSell = Math.max(...quotes.map(q => q.sell));

      quotes.forEach(q => {
        const li = document.createElement("li");
        li.className = "quote-row";

        const buyClass = q.buy === bestBuy ? "best-buy" : "";
        const sellClass = q.sell === bestSell ? "best-sell" : "";

        const logo = LOGOS[norm(q.exchange)] || FALLBACK_LOGO;

        li.innerHTML = `
          <div class="quote-left">
            <img class="exch-logo" src="${logo}" alt="">
            <span class="exch-name">${q.exchange}</span>
          </div>
          <div class="quote-right">
            <span class="price ${buyClass}">$ ${q.buy.toFixed(2)}</span>
            <span class="sub ${sellClass}">$ ${q.sell.toFixed(2)}</span>
          </div>
        `;
        list.appendChild(li);
      });
    }

    // 🔧 Datos de ejemplo (reemplazá por tu fetch real)
    const ejemplo = [
      {exchange: "Ripio", buy: 1395, sell: 1363},
      {exchange: "SatoshiTango", buy: 1397, sell: 1371},
      {exchange: "LemonCash", buy: 1404, sell: 1343},
      {exchange: "Buenbit", buy: 1386, sell: 1364},
      {exchange: "LetsBit", buy: 1379, sell: 1351},
      {exchange: "Binance", buy: 1380, sell: 1364},
      {exchange: "ArgenBTC", buy: 1000, sell: 900} // ← queda filtrado
    ];
    renderQuotes(ejemplo);

    /* ======== WIDGET: TradingView + Análisis técnico completo ======== */
    const FAVORITOS = ['BTCUSDT','ETHUSDT','SOLUSDT','BNBUSDT'];
    const TF_LIST   = ['5m','15m','30m','1h','4h','1d'];
    const TV_MAP    = {'5m':'5','15m':'15','30m':'30','1h':'60','4h':'240','1d':'D'};
    const st = { symbol:'BTCUSDT', tf:'15m' };

    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    function drawChips(){
      const fav = $('#aw-favs'); fav.innerHTML='';
      FAVORITOS.forEach(sym=>{
        const b = document.createElement('button');
        b.className = 'aw-chip'+(sym===st.symbol?' aw-active':'');
        b.textContent = sym.replace('USDT','');
        b.onclick = () => { st.symbol=sym; drawChips(); $('#aw-res').style.display='none'; setNews(); };
        fav.appendChild(b);
      });
      const tf = $('#aw-tfs'); tf.innerHTML='';
      TF_LIST.forEach(v=>{
        const b = document.createElement('button');
        b.className = 'aw-chip'+(v===st.tf?' aw-active':'');
        b.textContent = v;
        b.onclick = () => { st.tf=v; drawChips(); $('#aw-res').style.display='none'; };
        tf.appendChild(b);
      });
    }

    function mountTV(){
      $('#aw-tv').innerHTML='';
      new TradingView.widget({
        container_id: 'aw-tv', autosize: true, width:'100%', height:420,
        symbol: `BINANCE:${st.symbol}`, interval: TV_MAP[st.tf] || '15',
        timezone: 'America/Argentina/Buenos_Aires', theme:'dark', style:'1', locale:'es',
        hide_legend:false, enable_publishing:false
      });
    }

    function setNews(){
      const coin = st.symbol.replace('USDT','');
      $('#aw-news').href = `https://news.google.com/search?q=${
        encodeURIComponent(coin+' price OR crypto site:coindesk.com OR cointelegraph.com OR bloomberg.com OR infobae.com')
      }&hl=es-419&gl=AR&ceid=AR:es-419`;
    }

    // ==== Indicadores (RSI, EMA, MACD, ATR) ====
    function ema(arr,n){ const k = 2/(n+1); let e=arr[0]; const out=[e];
      for(let i=1;i<arr.length;i++){ e = arr[i]*k + e*(1-k); out.push(e); } return out; }
    function sma(arr,n){ const out=[]; let sum=0;
      for(let i=0;i<arr.length;i++){ sum+=arr[i]; if(i>=n) sum-=arr[i-n]; if(i>=n-1) out.push(sum/n); }
      while(out.length<arr.length) out.unshift(out[0]); return out; }
    function rsi(closes,n=14){ let g=0,l=0; const out=[];
      for(let i=1;i<closes.length;i++){ const d=closes[i]-closes[i-1];
        g=(g*(n-1)+Math.max(d,0))/n; l=(l*(n-1)+Math.max(-d,0))/n;
        const rs=l===0?100:g/l; out.push(100-(100/(1+rs))); }
      out.unshift(out[0]); return out; }
    function macd(cl, fast=12, slow=26, sig=9){
      const f=ema(cl,fast), s=ema(cl,slow); const line=f.map((v,i)=>v-s[i]);
      const signal=ema(line,sig); const hist=line.map((v,i)=>v-signal[i]); return {line,signal,hist};
    }
    function atr(candles,n=14){
      const trs=[candles[0].h-candles[0].l];
      for(let i=1;i<candles.length;i++){
        const h=candles[i].h, l=candles[i].l, pc=candles[i-1].c;
        trs.push(Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc)));
      }
      return sma(trs,n);
    }

    async function fetchKlines(symbol, tf, limit=300){
      const map = {'5m':'5m','15m':'15m','30m':'30m','1h':'1h','4h':'4h','1d':'1d'};
      const it = map[tf] || '15m';
      const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${it}&limit=${limit}`;
      const r = await fetch(url); const j = await r.json();
      return j.map(k=>({t:k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4]}));
    }

    function decide(last, rsiV, ema20, ema50, macdL, macdS, atrV, dMin, dMax){
      let bias='Esperar';
      if(ema20>ema50 && macdL>macdS && rsiV>45 && rsiV<75) bias='Long (alcista)';
      else if(ema20<ema50 && macdL<macdS && rsiV<55 && rsiV>25) bias='Short (bajista)';

      const risk = Math.max(atrV*0.9, last*0.003); // >=0.3%
      let entry=+last.toFixed(4), sl=null, tp1=null,tp15=null,tp2=null;
      if(bias.startsWith('Long')){
        sl = +(last - risk).toFixed(4);
        tp1 = +(last + risk*1.0).toFixed(4);
        tp15= +(last + risk*1.5).toFixed(4);
        tp2 = +(last + risk*2.0).toFixed(4);
      }else if(bias.startsWith('Short')){
        sl = +(last + risk).toFixed(4);
        tp1 = +(last - risk*1.0).toFixed(4);
        tp15= +(last - risk*1.5).toFixed(4);
        tp2 = +(last - risk*2.0).toFixed(4);
      }

      // evitar entrar pegado a extremos diarios
      const nearMin = last <= dMin*1.01;
      const nearMax = last >= dMax*0.99;
      if(bias.startsWith('Long') && nearMax) bias='Esperar (muy cerca del máximo diario)';
      if(bias.startsWith('Short')&& nearMin) bias='Esperar (muy cerca del mínimo diario)';

      return {bias, entry, sl, tp1, tp15, tp2};
    }

    async function runTA(){
      try{
        const ks = await fetchKlines(st.symbol, st.tf, 300);
        const closes = ks.map(k=>k.c);
        const last = closes.at(-1);

        // rango diario
        const dKs = await fetchKlines(st.symbol, '1d', 2);
        const today = dKs.at(-1); const dMin = today.l, dMax = today.h;

        // indicadores
        const e20 = ema(closes,20).at(-1);
        const e50 = ema(closes,50).at(-1);
        const r14 = rsi(closes,14).at(-1);
        const {line,signal} = macd(closes);
        const a14 = atr(ks,14).at(-1);

        const {bias, entry, sl, tp1, tp15, tp2} =
          decide(last, r14, e20, e50, line.at(-1), signal.at(-1), a14, dMin, dMax);

        // pintar
        $('#aw-res').style.display='block';
        $('#aw-bias').textContent = bias;
        $('#aw-entry').textContent = `$ ${entry}`;
        $('#aw-sl').textContent    = sl ? `$ ${sl}` : '—';
        $('#aw-tp').textContent    = (tp1 && tp15 && tp2) ? `$ ${tp1} / ${tp15} / ${tp2}` : '—';
        $('#aw-day').textContent   = `$ ${dMin.toFixed(2)} / $ ${dMax.toFixed(2)}`;
        $('#aw-ind').textContent   =
          `RSI14=${r14.toFixed(1)} • EMA20=${e20.toFixed(2)} • EMA50=${e50.toFixed(2)} • MACDΔ=${(line.at(-1)-signal.at(-1)).toFixed(4)} • ATR=${a14.toFixed(4)}`;

        // redacción completa (sin API): clara para trader
        const dir = bias.startsWith('Long') ? 'long' : bias.startsWith('Short') ? 'short' : 'esperar';
        let texto = '';
        if(dir==='long'){
          texto = `Estrategia LONG:
- Confirmar ruptura con volumen por encima de resistencias intradía.
- Entrada de referencia: $ ${entry}.
- Stop-loss: $ ${sl} (≈ riesgo ${ (entry-sl).toFixed(2) }).
- Take-profit: $ ${tp1} (1× ATR), $ ${tp15} (1.5×), $ ${tp2} (2×).
- Mientras EMA20 > EMA50 y MACD > señal, mantener; si RSI>75 o vela de rechazo fuerte, tomar ganancias parciales.`;
        } else if(dir==='short'){
          texto = `Estrategia SHORT:
- Confirmar rechazo en resistencias o pérdida de soportes con volumen.
- Entrada de referencia: $ ${entry}.
- Stop-loss: $ ${sl}.
- Take-profit: $ ${tp1} (1× ATR), $ ${tp15} (1.5×), $ ${tp2} (2×).
- Mientras EMA20 < EMA50 y MACD < señal, mantener; si RSI<25 o aparece vela envolvente alcista, cubrir.`;
        } else {
          texto = `Sin señal clara:
- El precio está cerca de extremos diarios o las medias están mixtas.
- Esperar ruptura con volumen o pullback a EMA20/50 con confirmación.
- Usar mínimos/máximos diarios como guía para invalidación.`;
        }
        $('#aw-text').textContent = texto;

      }catch(e){
        $('#aw-res').style.display='block';
        $('#aw-bias').textContent = 'Error al calcular';
        $('#aw-entry').textContent = '—';
        $('#aw-sl').textContent = '—';
        $('#aw-tp').textContent = '—';
        $('#aw-day').textContent = '— / —';
        $('#aw-ind').textContent = 'No se pudo obtener datos.';
        $('#aw-text').textContent = '';
      }
    }

    // eventos
    document.getElementById('aw-show').onclick = () => { mountTV(); setNews(); };
    document.getElementById('aw-run').onclick  = runTA;
    document.getElementById('aw-use').onclick  = () => {
      const v = document.getElementById('aw-other').value.trim().toUpperCase();
      if(v && /USDT$/.test(v)){ st.symbol=v; drawChips(); mountTV(); setNews(); document.getElementById('aw-res').style.display='none'; }
      else alert('Formato: TICKERUSDT (ej. ARBUSDT, PEPEUSDT)');
    };

    // init
    drawChips(); mountTV(); setNews();
  </script>
</body>
</html>
