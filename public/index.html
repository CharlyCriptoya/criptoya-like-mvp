<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="theme-color" content="#0b0f16"/>
<title>Arbolito ‚Äî Cotizaciones</title>
<style>
  :root{--text:#e5e7eb;--muted:#a1a1aa;--line:rgba(255,255,255,.08);--cardBg:rgba(10,13,20,.84);
        --chipBg:rgba(255,255,255,.06);--ok:#22c55e;--bad:#ef4444;--accent:#60a5fa;--vh:1svh}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="theme-color" content="#0b0f16"/>
<title>Arbolito ‚Äî Cotizaciones</title>
<style>
  :root{--text:#e5e7eb;--muted:#a1a1aa;--line:rgba(255,255,255,.08);--cardBg:rgba(10,13,20,.84);
        --chipBg:rgba(255,255,255,.06);--ok:#22c55e;--bad:#ef4444;--accent:#60a5fa;--vh:1svh}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color: <!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<meta name="theme-color" content="#0b0f16"/>
<title>Arbolito ‚Äî Cotizaciones</title>
<style>
  :root{--text:#e5e7eb;--muted:#a1a1aa;--line:rgba(255,255,255,.08);--cardBg:rgba(10,13,20,.84);
        --chipBg:rgba(255,255,255,.06);--ok:#22c55e;--bad:#ef4444;--accent:#60a5fa}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
       background:url('Muro.jpg') center/cover fixed no-repeat, url('public/Muro.jpg') center/cover fixed no-repeat, #0b0f16;overflow-x:hidden}
  .page{max-width:480px;margin:0 auto;padding:12px}
  h1{margin:6px 0 10px;font-size:18px;letter-spacing:.2px}
  .card{background:var(--cardBg);border:1px solid var(--line);border-radius:14px;padding:10px}
  .grid-dolar{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .dl-title{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .row{display:flex;justify-content:space-between;align-items:center;margin-top:4px;font-variant-numeric:tabular-nums}
  .row span:first-child{color:var(--muted);font-size:12px}
  .updated{margin-top:4px;font-size:11px;color:var(--muted)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .tab{padding:11px 14px;border-radius:999px;background:#fff;color:#0b0f16;border:1px solid #e5e7eb;font-size:14px;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.25)}
  .tab.active{background:#f3f4f6;border-color:#cbd5e1;box-shadow:0 0 0 2px rgba(255,255,255,.25) inset}
  .chip{font-size:11px;padding:2px 8px;border-radius:999px;background:var(--chipBg);border:1px solid var(--line);color:var(--muted)}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th,td{padding:10px 10px;text-align:left} th{font-size:11px;color:var(--muted);border-bottom:1px solid var(--line)}
  tbody tr{background:var(--cardBg);border:1px solid var(--line)}
  tbody td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .price{font-variant-numeric:tabular-nums}.green{color:var(--ok)}.red{color:var(--bad)}
  .meta{margin:8px 2px 2px;color:var(--muted);font-size:11px}
  .skeleton{background:linear-gradient(90deg,rgba(255,255,255,.04) 25%,rgba(255,255,255,.08) 37%,rgba(255,255,255,.04) 63%);
           background-size:400% 100%;animation:sh 1.2s ease infinite;border-radius:10px}
  @keyframes sh{0%{background-position:100% 50%}100%{background-position:0 50%}}
  a{color:var(--accent);text-decoration:none}
  /* ‚Äî‚Äî‚Äî Widget de gr√°ficos & IA ‚Äî‚Äî‚Äî */
  .ai-wrap{margin-top:12px}
  .ai-grid{display:grid;gap:10px}
  @media(min-width:520px){.ai-grid{grid-template-columns:1fr}}
  .ai-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .ai-toolbar input,.ai-toolbar select{background:rgba(255,255,255,.08);border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px}
  .btn{padding:9px 12px;border:1px solid var(--line);background:var(--chipBg);color:var(--text);border-radius:10px;cursor:pointer}
  .btn.primary{background:#fff;color:#111;border-color:#e5e7eb;font-weight:700}
  #chart{height:320px}
  .note{font-size:11px;color:var(--muted);margin-top:6px}
  .coin{width:16px;height:16px;vertical-align:-3px;border-radius:999px;margin-right:6px;background:#111;object-fit:cover}
  .badge{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid var(--line);background:var(--chipBg);margin-left:6px}
  .ai-out{white-space:pre-wrap;background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:13px;margin-top:8px}
</style>
</head>
<body>
<div class="page">
  <section>
    <h1>üí± Cotizaciones del D√≥lar (ARS)</h1>
    <div id="dolares" class="grid-dolar">
      <div class="card skeleton" style="height:70px"></div><div class="card skeleton" style="height:70px"></div>
      <div class="card skeleton" style="height:70px"></div><div class="card skeleton" style="height:70px"></div>
      <div class="card skeleton" style="height:70px"></div><div class="card skeleton" style="height:70px"></div>
    </div>
  </section>

  <section style="margin-top:12px">
    <div style="display:flex;align-items:center;gap:8px">
      <h1 style="margin:0">ü™ô Pares</h1>
      <span id="apiStatus" class="chip">API: comprobando‚Ä¶</span>
    </div>
    <div id="tabs" class="tabs"></div>

    <div class="card">
      <table>
        <thead><tr><th>Exchange</th><th>Par</th><th>Compra</th><th>Venta</th><th>24h</th><th>Act.</th></tr></thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="skeleton" style="height:46px"></td></tr>
          <tr><td colspan="6" class="skeleton" style="height:46px"></td></tr>
          <tr><td colspan="6" class="skeleton" style="height:46px"></td></tr>
        </tbody>
      </table>
    </div>
    <div class="meta">D√≥lar por <a href="https://dolarapi.com" target="_blank">dolarapi</a>. Cripto por <a href="https://criptoya.com" target="_blank">CriptoYa</a> y APIs oficiales (con fallback).</div>
  </section>

  <!-- ‚Äî‚Äî‚Äî WIDGET NUEVO: Gr√°fico + IA ‚Äî‚Äî‚Äî -->
  <section class="ai-wrap">
    <h1 style="margin:0 0 6px">üìà Gr√°fico & ü§ñ An√°lisis</h1>
    <div class="card">
      <div class="ai-grid">
        <div>
          <div class="ai-toolbar">
            <select id="wgExchange">
              <option value="binance">Binance</option>
              <option value="okx">OKX</option>
              <option value="bybit">Bybit</option>
              <option value="kucoin">KuCoin</option>
              <option value="mexc">MEXC</option>
              <option value="bingx">BingX</option>
            </select>
            <input id="wgBase" placeholder="BTC, ETH, SOL‚Ä¶" size="8"/>
            <select id="wgQuote">
              <option value="USDT">USDT</option>
              <!-- ARS podr√≠a agregarse m√°s adelante con s√≠ntesis -->
            </select>
            <select id="wgTF">
              <option value="1m">1m</option>
              <option value="5m">5m</option>
              <option value="15m">15m</option>
              <option value="1h">1h</option>
            </select>
            <button class="btn primary" id="btnLoad">Cargar gr√°fico</button>
            <button class="btn" id="btnDownload">Descargar PNG</button>
          </div>
          <div id="chart"></div>
          <div class="note">Tip: el Exchange del gr√°fico es el que elijas arriba. En la tabla de ‚ÄúPares‚Äù, el nombre del exchange abre su p√°gina de trading del par.</div>
        </div>
        <div>
          <div class="ai-toolbar">
            <input id="openaiKey" placeholder="Tu OpenAI API Key (sk-‚Ä¶)" style="flex:1;min-width:220px"/>
            <button class="btn" id="btnSaveKey">Guardar clave</button>
          </div>
          <button class="btn primary" id="btnAI">Analizar con IA</button>
          <span class="badge" id="autoSigToggle" role="switch" aria-checked="false" style="cursor:pointer">Auto-se√±ales: OFF</span>
          <div class="ai-out" id="aiOut">Carg√° un gr√°fico y opcionalmente peg√° tu clave de OpenAI para obtener un an√°lisis. Las auto-se√±ales usan EMA20/EMA50 y RSI14 locales (no IA).</div>
          <div class="note">‚ö†Ô∏è No es asesoramiento financiero. Us√° gesti√≥n de riesgo.</div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Librer√≠a de gr√°ficos (canvas) -->
<script src="https://unpkg.com/lightweight-charts@4.2.3/dist/lightweight-charts.standalone.production.js"></script>

<script>
/* ===== Utilidades ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const nfARS=new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:2});
const nfUS=new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtARS=n=> (n==null||isNaN(n))?'‚Äî':nfARS.format(n);
const fmtUSDT=n=> (n==null||isNaN(n))?'‚Äî':nfUS.format(n)+' USDT';
function ago(ts){ if(!ts) return '‚Äî'; const d=new Date(ts); const s=(Date.now()-d)/1000;
  if(s<60) return Math.floor(s)+'s'; if(s<3600) return Math.floor(s/60)+'m'; if(s<86400) return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d' }
function setApi(ok,extra=''){ $('#apiStatus').textContent=`API: ${ok?'OK':'problemas'}${extra?` ¬∑ ${extra}`:''}` }

/* ===== Fetch robusto: directo ‚Üí 3 proxys ===== */
const FETCH_TIMEOUT_MS=8000;
async function get(url){
  const tryFetch=async(u,opts={})=>{
    const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort('timeout'),FETCH_TIMEOUT_MS);
    try{ const r=await fetch(u,{cache:'no-store',mode:'cors',signal:ctrl.signal,...opts}); if(r.ok) return await r.text(); throw new Error('status '+r.status); }
    finally{ clearTimeout(to); }
  };
  try{ return JSON.parse(await tryFetch(url)); }catch(_){}
  try{ return JSON.parse(await tryFetch('https://api.allorigins.win/raw?url='+encodeURIComponent(url))); }catch(_){}
  try{ return JSON.parse(await tryFetch('https://thingproxy.freeboard.io/fetch/'+url)); }catch(_){}
  return JSON.parse(await tryFetch('https://cors.isomorphic-git.org/'+url));
}

/* ===== D√≥lar ===== */
const DOLLAR_KEYS=[
  {id:'oficial',labels:['oficial']},{id:'tarjeta',labels:['tarjeta','turista']},
  {id:'blue',labels:['blue']},{id:'mep',labels:['mep','bolsa']},
  {id:'ccl',labels:['ccl','contadoconliqui']},{id:'cripto',labels:['cripto']}
];

async function loadDolares(){
  const wrap=$('#dolares'); wrap.innerHTML='';
  let data={};
  try{
    const arr=await get('https://dolarapi.com/v1/dolares');
    const by={}; for(const it of arr){ by[(it.casa||it.nombre||'').toLowerCase()]=it }
    for(const {id,labels} of DOLLAR_KEYS){
      for(const L of labels){ const it=by[L]; if(it){ data[id]={compra:it.compra,venta:it.venta,updated:it.fecha||new Date().toISOString()}; break; } }
    }
  }catch(_){}
  try{
    const cy=await get('https://criptoya.com/api/dolar');
    const map={oficial:cy?.oficial,blue:cy?.blue,mep:cy?.mep,ccl:cy?.ccl,tarjeta:cy?.tarjeta||cy?.turista,cripto:cy?.cripto};
    for(const k in map){ if(!data[k]&&map[k]) data[k]={compra:map[k].compra,venta:map[k].venta,updated:map[k].fecha||new Date().toISOString()} }
  }catch(_){}
  const CARDS=[{k:'oficial',t:'Oficial'},{k:'tarjeta',t:'Tarjeta'},{k:'blue',t:'Blue'},{k:'mep',t:'MEP'},{k:'ccl',t:'CCL'},{k:'cripto',t:'Cripto'}];
  for(const c of CARDS){
    const v=data[c.k]||{}; const el=document.createElement('div'); el.className='card';
    el.innerHTML=`<div class="dl-title">D√ìLAR ${c.t.toUpperCase()}</div>
      <div class="row"><span>venta</span><strong>${fmtARS(v.venta)}</strong></div>
      <div class="row"><span>compra</span><span>${fmtARS(v.compra)}</span></div>
      <div class="updated">act: ${ago(v.updated)}</div>`;
    wrap.appendChild(el);
  }
}

/* ===== Cripto ===== */
const PAIRS=['USDT/ARS','USDC/ARS','DAI/USDT','BTC/USDT','ETH/USDT'];
const EX_ARSK=['letsbit','lemoncash','buenbit','ripio','argenbtc','fiwind','satoshitango'];
const EX_USDT=['binance','okx','bybit','kucoin','bingx','mexc'];
const state={pair:PAIRS[0]};

function iconUrl(sym){ return `https://cryptoicons.org/api/icon/${sym.toLowerCase()}/32`; } // simple y liviano

function buildTabs(){
  const c=$('#tabs'); c.innerHTML='';
  PAIRS.forEach(p=>{ const b=document.createElement('button');
    b.className='tab'+(p===state.pair?' active':''); b.textContent=p;
    b.onclick=()=>{ state.pair=p; $$('.tab').forEach(t=>t.classList.remove('active')); b.classList.add('active'); loadPair(); };
    c.appendChild(b);
  });
}

function tradeUrl(ex,base,quote){
  base=base.toUpperCase(); quote=quote.toUpperCase();
  switch(ex){
    case 'binance': return `https://www.binance.com/es/trade/${base}_${quote}?type=spot`;
    case 'okx':     return `https://www.okx.com/trade-spot/${base}-${quote}`;
    case 'bybit':   return `https://www.bybit.com/en/trade/spot/${base}/${quote}`;
    case 'kucoin':  return `https://www.kucoin.com/trade/${base}-${quote}`;
    case 'bingx':   return `https://bingx.com/en-us/spot/${base}-${quote}`;
    case 'mexc':    return `https://www.mexc.com/exchange/${base}_${quote}`;
    // locales (enlace gen√©rico a home/mercados)
    case 'letsbit': return `https://letsbit.io/`;
    case 'lemoncash': return `https://www.lemon.me/`;
    case 'buenbit': return `https://www.buenbit.com/`;
    case 'ripio': return `https://www.ripio.com/`;
    case 'argenbtc': return `https://www.argenbtc.com/`;
    case 'fiwind': return `https://www.fiwind.com.ar/`;
    case 'satoshitango': return `https://www.satoshitango.com/`;
    default: return '#';
  }
}

function cyUrl(ex,base,quote){ return `https://criptoya.com/api/${ex}/${base.toLowerCase()}/${quote.toLowerCase()}` }
async function fetchCY(ex,base,quote){
  const j=await get(cyUrl(ex,base,quote));
  const ts=j?.time?(typeof j.time==='number'?j.time*1000:j.time):Date.now();
  return {bid:j?.bid??j?.totalBid??null,ask:j?.ask??j?.totalAsk??null,chg:j?.change24h??j?.change??null,ts};
}

/* APIs oficiales para USDT */
async function fetchBinanceUSDT(base){ const j=await get(`https://api.binance.com/api/v3/ ticker/bookTicker?symbol=${(base+'USDT').toUpperCase()}`.replace(/\s+/g,'')); return {bid:+j.bidPrice,ask:+j.askPrice,chg:null,ts:Date.now()}; }
async function fetchOKXUSDT(base){ const j=await get(`https://www.okx.com/api/v5/market/ticker?instId=${(base+'-USDT').toUpperCase()}`); const d=j.data?.[0]||{}; return {bid:+d.bidPx,ask:+d.askPx,chg:null,ts:Date.now()}; }
async function fetchBybitUSDT(base){ const j=await get(`https://api.bybit.com/v5/market/tickers?category=spot&symbol=${(base+'USDT').toUpperCase()}`); const d=j.result?.list?.[0]||{}; return {bid:+d.bid1Price,ask:+d.ask1Price,chg:null,ts:Date.now()}; }
async function fetchKucoinUSDT(base){ const j=await get(`https://api.kucoin.com/api/v1/market/orderbook/level1?symbol=${(base+'-USDT').toUpperCase()}`); const d=j.data||{}; return {bid:+d.bestBid,ask:+d.bestAsk,chg:null,ts:Date.now()}; }
async function fetchBingxUSDT(base){ const j=await get(`https://api-swap-rest.bingx.com/openApi/spot/v1/ticker/bookTicker?symbol=${(base+'-USDT').toUpperCase()}`); const d=j.data||j||{}; return {bid:+(d.bidPrice||d.bestBid),ask:+(d.askPrice||d.bestAsk),chg:null,ts:Date.now()}; }
async function fetchMexcUSDT(base){ const j=await get(`https://api.mexc.com/api/v3/ticker/bookTicker?symbol=${(base+'USDT').toUpperCase()}`); return {bid:+j.bidPrice,ask:+j.askPrice,chg:null,ts:Date.now()}; }
async function fetchUSDTFromExchange(ex,base){
  try{
    switch(ex){ case 'binance': return await fetchBinanceUSDT(base);
      case 'okx': return await fetchOKXUSDT(base);
      case 'bybit': return await fetchBybitUSDT(base);
      case 'kucoin': return await fetchKucoinUSDT(base);
      case 'bingx': return await fetchBingxUSDT(base);
      case 'mexc': return await fetchMexcUSDT(base);
      default: throw new Error('ex no soportado'); }
  }catch(_){ return await fetchCY(ex,base,'USDT'); }
}

function renderRows(rows,quote){
  const tb=$('#tbody'); tb.innerHTML='';
  const fmt=quote==='ARS'?fmtARS:fmtUSDT;
  for(const r of rows){
    const [base]=r.par.split('/');
    const ch=typeof r.chg==='number'?(r.chg>=0?`+${r.chg.toFixed(2)}%`:`${r.chg.toFixed(2)}%`):'‚Äî';
    const chCls=typeof r.chg==='number'?(r.chg>=0?'green':'red'):'';
    const link=tradeUrl(r.exchange.toLowerCase(),base,quote);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><a href="${link}" target="_blank" rel="noopener">${r.exchange}</a></td>
      <td><img class="coin" src="${iconUrl(base)}" onerror="this.style.display='none'"/><span class="chip">${r.par}</span></td>
      <td class="price">${fmt(r.bid)}</td><td class="price">${fmt(r.ask)}</td>
      <td class="${chCls}">${ch}</td><td>${ago(r.ts)}</td>`;
    tb.appendChild(tr);
  }
}

async function loadPair(){
  const [base,quote]=state.pair.split('/');
  const tb=$('#tbody');
  tb.innerHTML=`<tr><td colspan="6" class="skeleton" style="height:46px"></td></tr>
                <tr><td colspan="6" class="skeleton" style="height:46px"></td></tr>
                <tr><td colspan="6" class="skeleton" style="height:46px"></td></tr>`;
  const exchanges = quote==='ARS'?EX_ARSK:EX_USDT;
  let ok=0, rows=[];
  if(quote==='ARS'){
    for(const ex of exchanges){
      try{ const d=await fetchCY(ex,base,'ARS'); rows.push({exchange:ex.toUpperCase(),par:`${base}/${quote}`,...d}); ok++; }
      catch{ rows.push({exchange:ex.toUpperCase(),par:`${base}/${quote}`,bid:null,ask:null,chg:null,ts:null}); }
    }
  }else{
    for(const ex of exchanges){
      try{ const d=await fetchUSDTFromExchange(ex,base); rows.push({exchange:ex.toUpperCase(),par:`${base}/${quote}`,...d}); ok++; }
      catch{ try{ const d2=await fetchCY(ex,base,'USDT'); rows.push({exchange:ex.toUpperCase(),par:`${base}/${quote}`,...d2}); ok++; }
             catch{ rows.push({exchange:ex.toUpperCase(),par:`${base}/${quote}`,bid:null,ask:null,chg:null,ts:null}); } }
    }
  }
  setApi(ok>0,`exchanges ${ok}/${exchanges.length}`);
  renderRows(rows,quote);
}

/* ====== WIDGET: Gr√°ficos + IA ====== */
let chart, candleSeries, lastCandles=[];
const chartEl = $('#chart');

function initChart(){
  chart?.remove();
  chart = LightweightCharts.createChart(chartEl,{ width: chartEl.clientWidth, height: 320, layout:{background:{type:'solid',color:'transparent'},textColor:'#e5e7eb'}, grid:{vertLines:{color:'rgba(255,255,255,0.06)'},horzLines:{color:'rgba(255,255,255,0.06)'}}, rightPriceScale:{borderVisible:false}, timeScale:{borderVisible:false} });
  candleSeries = chart.addCandlestickSeries();
  new ResizeObserver(()=> chart.applyOptions({width: chartEl.clientWidth}) ).observe(chartEl);
}

function mapToLWC(data){ // [{t, o,h,l,c}] -> {time,open,high,low,close}
  return data.map(d=>({time: Math.floor(d.t/1000), open:d.o, high:d.h, low:d.l, close:d.c}));
}

// C√°lculo de indicadores simples
function ema(values, period){
  const k=2/(period+1); const out=[]; let prev;
  for(let i=0;i<values.length;i++){
    const v=values[i];
    if(i<period-1){ out.push(null); continue; }
    if(i===period-1){ const sma=values.slice(0,period).reduce((a,b)=>a+b,0)/period; prev=sma; out.push(prev); continue; }
    prev = v*k + prev*(1-k); out.push(prev);
  }
  return out;
}
function rsi(values, period=14){
  let gains=0,losses=0; const rsis=[];
  for(let i=1;i<values.length;i++){
    const ch=values[i]-values[i-1];
    const gain=Math.max(ch,0), loss=Math.max(-ch,0);
    if(i<=period){ gains+=gain; losses+=loss; rsis.push(null); if(i===period){ const avgG=gains/period, avgL=losses/period; const rs=avgL===0?100:avgG/avgL; rsis[period]=100-(100/(1+rs)); } continue; }
    const prevRS = (rsis[i-1]!=null) ? ((100/(100-rsis[i-1]))-1) : 1;
    const avgG = (prevRS * (period-1) + gain) / period;
    const avgL = (((period-1)) + loss) / period; // aproximaci√≥n
    const RS = avgL===0?100:avgG/avgL;
    rsis.push( 100-(100/(1+RS)) );
  }
  return rsis;
}

async function fetchKlines(exchange, base, quote, tf){
  base=base.toUpperCase(); quote=quote.toUpperCase();
  // devolvemos [{t,o,h,l,c}]
  const L=300;
  try{
    switch(exchange){
      case 'binance':{
        const j=await get(`https://api.binance.com/api/v3/klines?symbol=${base+quote}&interval=${tf}&limit=${L}`);
        return j.map(k=>({t:+k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4]}));
      }
      case 'okx':{
        const map={ '1m':'1m','5m':'5m','15m':'15m','1h':'1H' };
        const j=await get(`https://www.okx.com/api/v5/market/candles?instId=${base+'-'+quote}&bar=${map[tf]||'1m'}&limit=${L}`);
        return (j.data||[]).reverse().map(k=>({t:+k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4]}));
      }
      case 'bybit':{
        const map={ '1m':'1','5m':'5','15m':'15','1h':'60' };
        const j=await get(`https://api.bybit.com/v5/market/kline?category=spot&symbol=${base+quote}&interval=${map[tf]||'1'}&limit=${L}`);
        return (j.result?.list||[]).reverse().map(k=>({t:+k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4]}));
      }
      case 'kucoin':{
        const map={ '1m':'1min','5m':'5min','15m':'15min','1h':'1hour' };
        const j=await get(`https://api.kucoin.com/api/v1/market/candles?type=${map[tf]||'1min'}&symbol=${base+'-'+quote}`);
        return (j.data||[]).reverse().map(k=>({t:+k[0]*1000, o:+k[1], c:+k[2], h:+k[3], l:+k[4]})).map(d=>({...d,c:d.c*1})); // normaliza types
      }
      case 'mexc':{
        const j=await get(`https://api.mexc.com/api/v3/klines?symbol=${base+quote}&interval=${tf}&limit=${L}`);
        return j.map(k=>({t:+k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4]}));
      }
      case 'bingx':{
        // BingX no siempre expone klines cross-origin; fallback a Binance mismo par
        const j=await get(`https://api.binance.com/api/v3/klines?symbol=${base+quote}&interval=${tf}&limit=${L}`);
        return j.map(k=>({t:+k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4]}));
      }
      default: throw new Error('exchange no soportado');
    }
  }catch(e){
    // √∫ltimo fallback a Binance
    const j=await get(`https://api.binance.com/api/v3/klines?symbol=${base+quote}&interval=${tf}&limit=${L}`);
    return j.map(k=>({t:+k[0], o:+k[1], h:+k[2], l:+k[3], c:+k[4]}));
  }
}

async function loadChartFromUI(){
  const ex=$('#wgExchange').value, base=$('#wgBase').value||'BTC', quote=$('#wgQuote').value||'USDT', tf=$('#wgTF').value||'1m';
  $('#aiOut').textContent='Cargando velas‚Ä¶';
  const data=await fetchKlines(ex,base,quote,tf);
  lastCandles=data;
  initChart();
  candleSeries.setData(mapToLWC(data));
  $('#aiOut').textContent=`Listo: ${ex.toUpperCase()} ${base}/${quote} ${tf}. Velas: ${data.length}.`;
}

function downloadPNG(){
  // Lightweight Charts usa <canvas> interno; tomamos el primero
  const cv = chartEl.querySelector('canvas');
  if(!cv){ alert('No hay canvas para descargar'); return; }
  const link=document.createElement('a');
  link.download=`chart_${Date.now()}.png`;
  link.href=cv.toDataURL('image/png');
  link.click();
}

// Se√±ales locales
function localSignal(){
  if(!lastCandles.length){ return 'Carg√° un gr√°fico primero.'; }
  const closes=lastCandles.map(d=>+d.c);
  const ema20=ema(closes,20), ema50=ema(closes,50);
  const rsi14=rsi(closes,14);
  const L=closes.length-1;
  const e20=ema20[L], e50=ema50[L], rsiV=rsi14[L]??null;
  let bias='NEUTRO';
  if(e20!=null && e50!=null){
    if(e20>e50) bias='ALCISTA';
    if(e20<e50) bias='BAJISTA';
  }
  const last=closes[L];
  // TP/SL simples
  const vol=Math.abs(last - lastCandles[L].o);
  const sl = bias==='ALCISTA' ? last - 2*vol : bias==='BAJISTA' ? last + 2*vol : last - 2*vol;
  const tp1= bias==='ALCISTA' ? last + 2*vol : last - 2*vol;
  const tp2= bias==='ALCISTA' ? last + 3*vol : last - 3*vol;
  const tp3= bias==='ALCISTA' ? last + 5*vol : last - 5*vol;

  return [
    `Se√±al (local): ${bias}`,
    `Precio actual: ${last}`,
    `EMA20: ${e20?.toFixed(4)} ¬∑ EMA50: ${e50?.toFixed(4)} ¬∑ RSI14: ${rsiV? rsiV.toFixed(2):'‚Äî'}`,
    `SL: ${sl.toFixed(4)} | TP1: ${tp1.toFixed(4)} ¬∑ TP2: ${tp2.toFixed(4)} ¬∑ TP3: ${tp3.toFixed(4)}`,
    `RR aprox.: 2‚Äì3x seg√∫n volatilidad reciente`
  ].join('\n');
}

/* ====== OpenAI (opcional) ====== */
function saveKey(){ localStorage.setItem('openai_key', $('#openaiKey').value.trim()); }
function loadKey(){ const k=localStorage.getItem('openai_key')||''; $('#openaiKey').value=k; }
async function analyzeWithAI(){
  const key=$('#openaiKey').value.trim();
  if(!key){ $('#aiOut').textContent='Peg√° tu OpenAI API Key para usar IA (o us√° las se√±ales locales).'; return; }
  if(!lastCandles.length){ $('#aiOut').textContent='Carg√° un gr√°fico primero.'; return; }
  const [ex,base,quote,tf]=[$('#wgExchange').value,$('#wgBase').value||'BTC',$('#wgQuote').value||'USDT',$('#wgTF').value||'1m'];
  const rows=lastCandles.slice(-180).map(c=>({t:c.t, o:+c.o, h:+c.h, l:+c.l, c:+c.c}));
  const prompt = `Sos un analista t√©cnico. Con los datos OHLC (√∫ltimas ${rows.length} velas) del par ${base}/${quote} en ${ex} timeframe ${tf}, indic√°:
- Escenario (alcista/bajista/lateral).
- Estrategia sugerida (long/short o esperar), nivel de ENTRADA, 3 niveles de TAKE PROFIT y STOP LOSS.
- Justificaci√≥n con 2‚Äì3 indicadores (EMA20/50, RSI14, soportes/resistencias).
- Gesti√≥n de riesgo sugerida (riesgo 1‚Äì2%, RR >= 2).
Datos JSON: ${JSON.stringify(rows)}`;

  $('#aiOut').textContent='Consultando IA‚Ä¶';
  try{
    const r = await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body: JSON.stringify({
        model:'gpt-4o-mini',
        temperature:0.3,
        messages:[
          {role:'system', content:'Responde en espa√±ol, conciso y accionable.'},
          {role:'user', content: prompt}
        ]
      })
    });
    const j = await r.json();
    const txt = j?.choices?.[0]?.message?.content || JSON.stringify(j);
    $('#aiOut').textContent = txt;
  }catch(e){
    $('#aiOut').textContent = 'Error al llamar a OpenAI. Revis√° la clave y conexi√≥n.';
  }
}

/* ===== INIT ===== */
function attachWidgetEvents(){
  $('#btnLoad').onclick=loadChartFromUI;
  $('#btnDownload').onclick=downloadPNG;
  $('#btnAI').onclick=analyzeWithAI;
  $('#btnSaveKey').onclick=()=>{saveKey(); $('#aiOut').textContent='Clave guardada en este navegador.'};
  $('#autoSigToggle').onclick=()=>{
    const el=$('#autoSigToggle');
    const on = el.getAttribute('aria-checked')==='true';
    if(on){ clearInterval(window._sigTimer); el.setAttribute('aria-checked','false'); el.textContent='Auto-se√±ales: OFF'; }
    else { window._sigTimer=setInterval(()=>{ $('#aiOut').textContent=localSignal(); },30000); $('#aiOut').textContent=localSignal(); el.setAttribute('aria-checked','true'); el.textContent='Auto-se√±ales: ON'; }
  };
  loadKey();
}

(async function(){
  buildTabs();
  await loadDolares();
  await loadPair();
  setInterval(loadDolares,60000);
  setInterval(loadPair,60000);

  initChart();
  attachWidgetEvents();
})();
</script>

<!-- build marker -->
<div style="position:fixed;bottom:8px;right:10px;font:12px system-ui;color:#9ca3af;">build v1.9</div>
</body>
</html>
