<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Comparador Cripto • Multi-Exchange (WS) + Fondo Muro</title>
<style>
  :root{--bg:#0f1222;--card:#171a2e;--text:#e8ecf1;--muted:#9aa3b2;--ok:#2ecc71;--bad:#e74c3c;--line:#232642;--accent:#5b8cff}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  body{
    margin:0;color:var(--text);
    background:linear-gradient(180deg, rgba(10,12,25,.85), rgba(10,12,25,.85));
    background-attachment:fixed;background-size:cover;
  }
  header{padding:16px 18px;border-bottom:1px solid var(--line);backdrop-filter: blur(6px);background:rgba(12,14,30,.6);position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:18px;letter-spacing:.3px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .control{background:rgba(23,26,46,.82);border:1px solid var(--line);padding:8px 10px;border-radius:10px;display:flex;align-items:center;gap:8px}
  select,input{background:#0c1022;border:1px solid #2a2e4a;color:var(--text);padding:8px 10px;border-radius:8px}
  button{background:var(--accent);border:none;color:white;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid var(--line)}
  main{max-width:1000px;margin:18px auto;padding:0 16px 40px}
  .card{background:rgba(23,26,46,.82);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #293050;text-align:left}
  th{font-size:12px;color:#c6ccdb;text-transform:uppercase;letter-spacing:.5px}
  .price{font-weight:800}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .muted{color:var(--muted);font-size:12px}
  .chip{display:inline-block;border:1px solid #2a2e4a;border-radius:999px;padding:4px 8px;font-size:12px;color:#c7cee0}
  .blink-up{animation:blinkUp .6s ease} .blink-down{animation:blinkDown .6s ease}
  @keyframes blinkUp{0%{background:rgba(46,204,113,.18)}100%{background:transparent}}
  @keyframes blinkDown{0%{background:rgba(231,76,60,.18)}100%{background:transparent}}
  .best{outline:2px solid var(--ok);outline-offset:-2px;border-radius:6px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
</style>
</head>
<body>
<header>
  <h1>Comparador en vivo • Binance + Kraken + Bitstamp</h1>
  <div class="controls">
    <div class="control">
      <label>Par</label>
      <select id="symbol">
        <option value="BTCUSDT" selected>BTC/USDT</option>
        <option value="ETHUSDT">ETH/USDT</option>
        <option value="SOLUSDT">SOL/USDT</option>
        <option value="BNBUSDT">BNB/USDT</option>
      </select>
    </div>
    <div class="control">
      <label>o escribir</label>
      <input id="custom" type="text" placeholder="Ej: XRPUSDT" />
      <button id="useCustom" class="ghost">Usar</button>
    </div>
    <div class="control"><span class="chip">Última actualización: <span id="lastUpdate">—</span></span></div>
    <div class="control"><button id="testBtn" class="ghost">Test REST (diagnóstico)</button></div>
  </div>
</header>

<main>
  <section class="card">
    <div class="row"><strong id="pairLbl">BTC/USDT</strong><span class="muted">WebSockets en vivo; Bitstamp usa USD</span></div>
    <table>
      <thead><tr><th>Exchange</th><th>Precio</th><th>Var 60s</th><th>Estado</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
    <div class="muted" style="margin-top:8px">Si alguno marca rojo, mirá el panel de diagnóstico abajo.</div>
  </section>

  <section class="card">
    <div class="row"><strong>Arbitraje rápido</strong><span class="muted">min vs. max (último precio)</span></div>
    <div id="arbBox" class="muted">Esperando 2 exchanges…</div>
  </section>

  <section class="card">
    <div class="row"><strong>Diagnóstico</strong><span class="muted">para detectar por qué “no muestra nada”</span></div>
    <div id="diag" class="muted">Listo para probar.</div>
  </section>
</main>

<script>
/* ===== Fondo: usa muro.jpg si existe, si no prueba variantes automáticamente ===== */
(function(){
  const candidatas=['muro.jpg','muro.jpeg','muro.png','bg.jpg','bg.jpeg','bg.png'];
  (function probar(i){
    if(i>=candidatas.length) return;
    const img=new Image();
    img.onload=()=>{document.body.style.background=
      `linear-gradient(180deg, rgba(10,12,25,.85), rgba(10,12,25,.85)), url('${candidatas[i]}') center/cover fixed no-repeat`};
    img.onerror=()=>probar(i+1);
    img.src=candidatas[i]+'?v='+Date.now();
  })(0);
})();

/* ===== Utilidades ===== */
const $=id=>document.getElementById(id);
const fmt=n=> (n==null||isNaN(n))?'—':Number(n).toLocaleString(undefined,{
  minimumFractionDigits: (Math.abs(n)>=100000?0:Math.abs(n)>=1000?2:4),
  maximumFractionDigits: (Math.abs(n)>=100000?0:Math.abs(n)>=1000?2:4)
});
const nowStr=()=>new Date().toLocaleTimeString();

/* ===== Estado ===== */
const state={
  symbol:'BTCUSDT',
  prices:{binance:null, kraken:null, bitstamp:null},
  prev:{}, hist:[], sockets:{}
};

/* ===== Tabla UI ===== */
function buildRows(){
  const tbody=$('rows'); tbody.innerHTML='';
  ['Binance','Kraken','Bitstamp'].forEach(name=>{
    const k=name.toLowerCase();
    const tr=document.createElement('tr'); tr.id='row-'+k;
    tr.innerHTML=`
      <td><strong>${name}</strong> <span class="muted" id="${k}-pair"></span></td>
      <td class="price" id="${k}-price">—</td>
      <td id="${k}-var">—</td>
      <td id="${k}-status" class="muted">Conectando…</td>`;
    tbody.appendChild(tr);
  });
}
buildRows();

/* ===== Mapeos ===== */
const map={
  binance:(sym)=>({ stream: sym.toLowerCase()+'@trade', display: sym.replace('USDT','/USDT') }),
  kraken:(sym)=>{ const base=sym.startsWith('BTC')?'XBT':sym.startsWith('ETH')?'ETH':sym.replace('USDT','');
    return { pair: base+'/USDT', display: base+'/USDT' }; },
  bitstamp:(sym)=>{ const base=sym.replace('USDT','').toLowerCase();
    return { channel: 'live_trades_'+base+'usd', display: base.toUpperCase()+'/USD' }; }
};

/* ===== Conexiones ===== */
function connectAll(sym){
  cleanup();
  state.symbol=sym.toUpperCase();
  $('pairLbl').textContent=state.symbol.replace('USDT','/USDT');
  $('lastUpdate').textContent='—';
  state.prices={binance:null,kraken:null,bitstamp:null}; state.hist.length=0;
  buildRows();

  connectBinance(sym);
  connectKraken(sym);
  connectBitstamp(sym);
}

function update(ex, price){
  state.prices[ex]=price;
  $('lastUpdate').textContent=nowStr();

  const priceEl=$(ex+'-price');
  const prev=state.prev[ex];
  priceEl.textContent=fmt(price);
  if(prev!=null){
    const row=$('row-'+ex); const cls=price>prev?'blink-up':price<prev?'blink-down':'';
    if(cls){row.classList.remove('blink-up','blink-down'); void row.offsetWidth; row.classList.add(cls);}
  }
  state.prev[ex]=price;

  // var 60s usando hist binance como referencia
  if(state.hist.length>3){
    const p60=state.hist[0].p;
    const chg=((price-p60)/p60)*100;
    const v=$(ex+'-var'); v.textContent=(chg>=0?'+':'')+chg.toFixed(2)+'%';
    v.className=chg>=0?'ok':'bad';
  }
  computeArb();
}

function setStatus(ex, text, ok=true){
  const el=$(ex+'-status'); el.textContent=text; el.className= ok?'ok':'bad';
}

function connectBinance(sym){
  const m=map.binance(sym); $('binance-pair').textContent=' '+m.display;
  const url=`wss://stream.binance.com:9443/ws/${m.stream}`;
  let tries=0;
  (function open(){
    const ws=new WebSocket(url); state.sockets.binance=ws;
    ws.onopen=()=>setStatus('binance-status','OK',true);
    ws.onmessage=e=>{
      const d=JSON.parse(e.data); const p=parseFloat(d.p);
      if(!isNaN(p)){ update('binance',p); pushHist(p, d.T||Date.now()); }
    };
    ws.onclose=()=>{ setStatus('binance-status','Reintentando…',false);
      setTimeout(open, Math.min(15000, 1000*Math.pow(2,tries++))); };
    ws.onerror=()=>{ try{ws.close();}catch{} };
  })();
}

function connectKraken(sym){
  const m=map.kraken(sym); $('kraken-pair').textContent=' '+m.display;
  let tries=0;
  (function open(){
    const ws=new WebSocket('wss://ws.kraken.com/'); state.sockets.kraken=ws;
    ws.onopen=()=>{ setStatus('kraken-status','Suscribiendo…',true);
      ws.send(JSON.stringify({event:'subscribe', pair:[m.pair], subscription:{name:'ticker'}})); };
    ws.onmessage=e=>{
      const msg=JSON.parse(e.data);
      if(Array.isArray(msg)&&msg[1]&&msg[1].c){ const p=parseFloat(msg[1].c[0]); if(!isNaN(p)) update('kraken',p); }
      if(msg.event==='systemStatus') setStatus('kraken-status','OK',true);
    };
    ws.onclose=()=>{ setStatus('kraken-status','Reintentando…',false);
      setTimeout(open, Math.min(15000, 1000*Math.pow(2,tries++))); };
    ws.onerror=()=>{ try{ws.close();}catch{} };
  })();
}

function connectBitstamp(sym){
  const m=map.bitstamp(sym); $('bitstamp-pair').textContent=' '+m.display;
  let tries=0;
  (function open(){
    const ws=new WebSocket('wss://ws.bitstamp.net'); state.sockets.bitstamp=ws;
    ws.onopen=()=>{ setStatus('bitstamp-status','Suscribiendo…',true);
      ws.send(JSON.stringify({event:'bts:subscribe', data:{channel:m.channel}})); };
    ws.onmessage=e=>{
      const msg=JSON.parse(e.data);
      if(msg.event==='trade' && msg.data && msg.data.price){ const p=parseFloat(msg.data.price); if(!isNaN(p)) update('bitstamp',p); }
      if(msg.event==='bts:subscription_succeeded') setStatus('bitstamp-status','OK',true);
    };
    ws.onclose=()=>{ setStatus('bitstamp-status','Reintentando…',false);
      setTimeout(open, Math.min(15000, 1000*Math.pow(2,tries++))); };
    ws.onerror=()=>{ try{ws.close();}catch{} };
  })();
}

/* ===== Hist 60s para % var (tomamos Binance para anclar) ===== */
function pushHist(p, t){
  const now=t||Date.now(); state.hist.push({t:now,p});
  const cutoff=now-60000; while(state.hist.length && state.hist[0].t<cutoff) state.hist.shift();
}

/* ===== Arbitraje ===== */
function computeArb(){
  const entries=Object.entries(state.prices).filter(([,v])=>v!=null);
  if(entries.length<2){ $('arbBox').textContent='Esperando 2 exchanges…'; return; }
  entries.sort((a,b)=>a[1]-b[1]);
  const [minEx,minP]=entries[0]; const [maxEx,maxP]=entries[entries.length-1];
  const spread=((maxP-minP)/minP)*100;
  $('arbBox').innerHTML=`
    <div>Comprar en <b>${cap(minEx)}</b> a <b>${fmt(minP)}</b></div>
    <div>Vender en <b>${cap(maxEx)}</b> a <b>${fmt(maxP)}</b></div>
    <div style="margin-top:6px"><b>Spread potencial:</b> ${spread.toFixed(3)}%</div>
    <div class="muted" style="margin-top:6px">No incluye fees/tiempos de fondeo y retiro.</div>`;
  highlightBest(minEx,maxEx);
}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}
function highlightBest(minEx,maxEx){
  ['binance','kraken','bitstamp'].forEach(ex=>{ const r=$('row-'+ex); if(r) r.classList.remove('best'); });
  const r1=$('row-'+minEx), r2=$('row-'+maxEx); if(r1) r1.classList.add('best'); if(r2&&r2!==r1) r2.classList.add('best');
}

/* ===== Limpieza ===== */
function cleanup(){ for(const k of Object.keys(state.sockets)){ try{const ws=state.sockets[k]; if(ws){ws.onopen=ws.onmessage=ws.onclose=ws.onerror=null; ws.close();}}catch{} state.sockets[k]=null; }}

/* ===== UI ===== */
$('symbol').addEventListener('change',e=>connectAll(e.target.value));
$('useCustom').addEventListener('click',()=>{const s=$('custom').value.trim().toUpperCase(); if(!s) return; $('symbol').value=s; connectAll(s);});

/* ===== Diagnóstico ===== */
function logDiag(msg, ok){
  const el=$('diag'); const line=document.createElement('div'); line.innerHTML= ok?`<span class="ok">✔</span> ${msg}`:`<span class="bad">✖</span> ${msg}`;
  el.appendChild(line);
}
$('testBtn').addEventListener('click', async ()=>{
  try{
    // Test sencillo con REST público de Binance (no WebSocket)
    const s=state.symbol.toUpperCase();
    const r=await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${s}`, {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j=await r.json();
    logDiag(`REST OK Binance ${s}: ${j.price}`, true);
  }catch(e){ logDiag('REST Binance bloqueado por red o CORS: '+(e.message||e), false); }
});

/* ===== Start ===== */
connectAll(state.symbol);
window.addEventListener('beforeunload', cleanup);
</script>
</body>
</html>
